<!DOCTYPE html>
<html>

<head>
  <meta charset=utf-8 />
  <title>DeltaV-map-extended</title>
  <style>
    /*html, body {margin: 0; height: 100%; overflow: hidden}*/
    input[type='number']::-webkit-inner-spin-button,
    input[type='number']::-webkit-outer-spin-button {
      -webkit-appearance: none;
      appearance: none;
      margin: 0;
    }

    .sliderInput {
      -webkit-appearance: none;
      appearance: none;
      position: absolute;
      height: 12px;
      width: 50px;
      border-radius: 5px;
      text-align: center;
      font-family: Courier New, serif;
      font-weight: bold;
      color: #00508a;
    }

    .slider {
      -webkit-appearance: none;
      appearance: none;
      position: absolute;
      width: 200px;
      height: 15px;
      border-radius: 15px;
      background: #d3d3d3;
      outline: none;
      opacity: 0.8;
      -webkit-transition: .2s;
      transition: opacity .2s;
    }
    
    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      perspective: 1px;
      width: 20px;
      height: 20px;
      border: 3px solid #00508a;
      border-collapse: separate;
      border-radius: 20px;
      background: #ffffff;
      opacity: 1;
      cursor: grab;
    }

    .slider:hover {
      opacity: 1;
      /* Fully shown on mouse-over */
      background: #189aca;
      cursor: pointer;
    }

    .OutputLabel {
      -webkit-appearance: none;
      position: absolute;
      font-family: Garamond, serif;
      font-size: 14px;
      color: #757575;
    }
    .OutputData{
      -webkit-appearance: none;
      appearance: none;
      position: absolute;
      height: 18px;
      width: 85px;
      font-family: Courier New, serif;
      font-size: 16px;
      font-weight: bold;
      color: #189aca;
      text-align: right;
      background-color: #ffffff;
      border: 1px solid #00508a;
      -webkit-border-radius: 5px;
      -moz-border-radius: 5px;
      -khtml-border-radius: 5px;
      border-radius: 5px;
      border-collapse: separate;
      transform: translateZ(0);
    }
    .unitdropdown{
      font-family: Garamond, serif;
      font-size: 15px;
      text-align: right;
      color: #00508a;
      border: 0px;
    }
    
     /* The container */
    .container {
      /*display: block;*/
      position: absolute;
      cursor: pointer;
      font-family: Garamond, serif;
      font-size: 14px;
      color: #00508a;
      /*
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;*/
    }

    /* Hide the browser's default radio button */
    .container input {
      position: absolute;
      opacity: 0;
      cursor: pointer;
      color: #ff0000;
    }

    /* Create a custom radio button */
    
    .checkmark {
      /* remove the 'background-color: #ff0000;' line below to make them invisible */
      appearance: none;/**/
      /*background-color: #ff0000;/**/
      /* */
      position: absolute;
      height: 21px;
      width: 21Px;
      border-radius: 50%;
      cursor: pointer;
    }

    /* On mouse-over, add a grey background color */
    .container:hover input ~ .checkmark {
      position: absolute;
      color: #189aca;
    }

    /* When the radio button is checked, add a blue background */
    .container input:checked ~ .checkmark {
      position: absolute;
      background-color: #ff0000;
      color: #ff0000;
    }

    /* Create the indicator (the dot/circle - hidden when not checked) */
    .checkmark:after {
      content: "";
      position: absolute;
      display: none;/**/
      color: #ff0000;
    }

    /* Show the indicator (dot/circle) when checked */
    .container input:checked ~ .checkmark:after {
      display: block;*/
      color: #ff0000;
    }

    /* Style the indicator (dot/circle) */
    .container .checkmark:after {
      height: 21px;
      width: 21Px;
      border-radius: 50%;
      color: #ff0000;
    }
    #tooltip {
position: absolute;
background: #333;
color: white;
padding: 4px 6px;
font-size: 12px;
display: none;
pointer-events: none;
}

  </style>
</head>

<body>
  <canvas id="BorderCanvas"></canvas>
  <script type="text/javascript">
    var canvas = document.getElementById('BorderCanvas');
    if (canvas.getContext) {
      var context = canvas.getContext('2d');
      var xsize = 880;
      var ysize = 1275;
      canvas.style.width = xsize + "px";
      canvas.style.height = ysize + "px";
      // Set actual size in memory (scaled to account for extra pixel density).
      var scale = 2; //window.devicePixelRatio; // Change to 1 on retina screens to see blurry canvas.
      canvas.width = Math.floor(xsize * scale);
      canvas.height = Math.floor(ysize * scale);
      // Normalize coordinate system to use css pixels.
      context.scale(scale, scale);
      context.clearRect(0, 0, canvas.width / scale, canvas.height / scale);
      context.beginPath();
      context.lineJoin = "round";
      context.moveTo(0, 0);
      context.lineTo(canvas.width / scale, 0);
      context.strokeStyle = '#00508a';
      context.stroke();
      ////
      context.beginPath();
      context.lineJoin = "round";
      context.moveTo(0, 0);
      context.lineTo(0, canvas.height / scale);
      context.stroke();
      ////
      context.beginPath();
      context.lineJoin = "round";
      context.moveTo(canvas.width / scale, canvas.height / scale);
      context.lineTo(canvas.width / scale, 0);
      context.stroke();
      ////
      context.beginPath();
      context.lineJoin = "round";
      context.moveTo(canvas.width / scale, canvas.height / scale);
      context.lineTo(0, canvas.height / scale);
      context.stroke();
      ////
    }
  </script>
  <div class="FLabel1" z-index: 1; style="position:absolute; left:297px; top:105px; font-family: Garamond, serif; font-size: 14px; color: #757575;">
    Thrust per engine
  </div>
  <div class="IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII"> </div>
    
    <div id="ISPlabel1" class="OutputLabel" z-index: 1 style="position:absolute; left:544px; top:105px; font-size: 14px;">
      I
    </div>
    <div id="ISPlabel2" class="OutputLabel" z-index: 1 style="position:absolute; left:550px; top:112px; font-size: 11px;">
      SP
    </div>
    <div id="ISPlabel3" class="OutputLabel" z-index: 1 style="position:absolute; left:564px; top:105px; font-size: 12px;">
      (Specific Impulse)
    </div>
  
    <div id="ISP2output" class="OutputData" z-index: 1 style="position:absolute; left:715px; top:773px;display:none">
      ISP2
    </div>
    <div id="ISP2label1" class="OutputLabel" z-index: 1 style="position:absolute; left:718px; top:753px; font-size: 14px;display:none">
      I
    </div>
    <div id="ISP2label2" class="OutputLabel" z-index: 1 style="position:absolute; left:723px; top:758px; font-size: 11px;display:none">
      SP
    </div>
    <div id="ISP2label3" class="OutputLabel" z-index: 1 style="position:absolute; left:738px; top:753px; font-size: 12px;display:none">
      (Specific Impulse)
    </div>
    <div class="OutputLabel" z-index: 1 style="position:absolute; left:835px; top:775px; text-align: left; width: 25px;display:none">
      s
    </div>
  
    <div id="FTotaloutput" class="OutputData" z-index: 1 style="position:absolute; left:730px; top:230px;display:none">
      FTotal
    </div>
    <div id="FTotallabel" class="OutputLabel" z-index: 1 style="position:absolute; left:737px; top:210px; text-align: center; width: 100px;display:none">
      Total Thrust
    </div>
    <div class="OutputLabel" z-index: 1 style="position:absolute; left:850px; top:232px; text-align: left; width: 25px;display:none">
      N
    </div>
  
    <div id="DVoutput" class="OutputData" z-index: 1 style="position:absolute; left:777.7px; top:130px;">
      DV
    </div>
    <div id="DVlabel" class="OutputLabel" z-index: 1 style="position:absolute; left:692px; top:132px; text-align: center; width: 100px;">
      ∆V (km/s):
    </div>
  
    <div id="TWRoutput" class="OutputData" z-index: 1 style="position:absolute; left:777.7px; top:235px;">
      TWR
    </div>
    <div id="TWRlabel" class="OutputLabel" z-index: 1 style="position:absolute; left:603px; top:237px; text-align: center; width: 200px;">
      Thrust-to-Weight Ratio:
    </div>

    <div class="slidecontainer">
      <form>
    <div class="OutputLabel" z-index: 1 style="position:absolute; left:665px; top:65px; text-align: right; width: 25px;">
      s
  </div>
    <div class="OutputLabel" z-index: 1 style="position:absolute; left:667.5px; top:105px; text-align: right; width: 25px;">
      900
  </div>
    <div class="OutputLabel" z-index: 1 style="position:absolute; left:488px; top:105px; text-align: left; width: 25px;">
      1
  </div>
        <input id="ISPslider" class="slider" type="range" name="ISPslider" min="1" max="900" step="0.01" value="200" oninput="this.form.ISPinput.value=this.value;ISPChangeFunction(this.value);" />
        <input id="ISPinput" class="sliderInput" type="number" name="ISPInput" min="0.01" max="900" value="200" oninput="this.value=Math.min(this.max,Math.max(this.min,this.value));this.form.ISPslider.value=this.value;ISPChangeFunction(this.value);"/>
      </form>
      <form>
    <div class="OutputLabel" z-index: 1 style="position:absolute; left:415px; top:65px; text-align: right; width: 25px;">
      N
  </div>
    <div class="OutputLabel" z-index: 1 style="position:absolute; left:418px; top:105px; text-align: right; width: 25px;">
      1e9
  </div>
    <div class="OutputLabel" z-index: 1 style="position:absolute; left:238px; top:105px; text-align: left; width: 25px;">
      1e-1
  </div>
        <input id="FSlider" class="slider" type="range" name="FSlider" min="-1" max="9" step="0.001" value="7" oninput="this.form.FInput.value=Math.pow(10,this.value).toPrecision(5);FChangeFunction(Math.pow(10,this.value));" />
        <input id="FInput" class="sliderInput" type="number" name="FInput" min="0.1" max="1e9" value="5e6" step="0.1" oninput="this.value=(Math.min(this.max,Math.max(this.min,this.value)));this.form.FSlider.value=Math.log10(this.value);FChangeFunction(this.value);" onchange="this.value=(Math.min(this.max,Math.max(this.min,this.value))).toPrecision(5);this.form.FSlider.value=Math.log10(this.value);FChangeFunction(this.value);" />
      </form>
    
    <div class="slidecontainer">
      <form>
        <input id="engNoSlider" class="slider" type="range" name="engNoSlider" min="1" max="9" step="1" value="5" oninput="this.form.engNoInput.value=this.value;engNoChangeFunction(this.value);" style="position:absolute; top:85px; left:52px; width: 140px;"/>
        <input id="engNoInput" class="sliderInput" type="number" name="engNoInput" min="1" max="9" value="5" oninput="this.value=Math.min(this.max,Math.max(this.min,this.value));this.form.engNoSlider.value=this.value;engNoChangeFunction(this.value);" style="position:absolute; top:65px; left:95.3px; border: 1px solid #00508a;"/>
      </form>
  </div>
  <div class="engNoLabel" z-index: 1; style="position:absolute; top:105px; left:68.7px; font-family: Garamond, serif; font-size: 14px; color: #757575;">
    Number of Engines
  </div>
  
   <div class="slidecontainer">
      <form>
        <input id="engMassSlider" class="slider" type="range" name="engMassSlider" min="1" max="1000" step="0.1" value="8" oninput="this.form.engMassInput.value=this.value;engMassChangeFunction(this.value);" style="position:absolute; top:283px; left:52px; width: 140px;"/>
        <input id="engMassInput" class="sliderInput" type="number" name="engMassInput" min="1" max="1000" value="8" oninput="this.value=Math.min(this.max,Math.max(this.min,this.value));this.form.engMassSlider.value=this.value;engMassChangeFunction(this.value);" style="position:absolute; top:262px; left:95.3px; border: 1px solid #00508a;"/>
      </form>
      <select id="engMassUnit" class="unitdropdown" style="position:absolute; top:259px; left:164.7px" oninput="engMassUnitChangeFunction();">
        <option value="kg">kg</option>
        <option value="t" selected>t</option>
      </select>
  </div>
  <div class="engMassLabel" z-index: 1; style="position:absolute; top:304px; left:68.7px; font-family: Garamond, serif; font-size: 14px; color: #757575;">
    Engine Unit Mass
  </div>
  
    <div class="slidecontainer">
      <form>
        <input id="fuelMassSlider" class="slider" type="range" name="fuelMassSlider" min="1" max="3000" step="0.1" value="2077" oninput="this.form.fuelMassInput.value=this.value;fuelMassChangeFunction(this.value);" style="position:absolute; top:283px; left:238px;width:200px;"/>
        <input id="fuelMassInput" class="sliderInput" type="number" name="fuelMassInput" min="1" max="3000" value="2077" oninput="this.value=Math.min(this.max,Math.max(this.min,this.value));this.form.fuelMassSlider.value=this.value;fuelMassChangeFunction(this.value);" style="position:absolute; top:262px; left:311px; border: 1px solid #00508a;"/>
      </form>
      <select id="fuelMassUnit" class="unitdropdown" style="position:absolute; top:259px; left:410px" oninput="fuelMassUnitChangeFunction();">
        <option value="kg">kg</option>
        <option value="t" selected>t</option>
      </select>
  </div>
  <div class="fuelMassLabel" z-index: 1; style="position:absolute; top:304px; left:310px; font-family: Garamond, serif; font-size: 14px; color: #757575;">
    Fuel Mass
  </div>
  
  <div class="slidecontainer">
      <form>
        <input id="payloadMassSlider" class="slider" type="range" name="payloadMassSlider" min="1" max="3000" step="0.1" value="850" oninput="this.form.payloadMassInput.value=this.value;payloadMassChangeFunction(this.value);" style="position:absolute; top:283px; left:488px;width:200px;"/>
        <input id="payloadMassInput" class="sliderInput" type="number" name="payloadMassInput" min="1" max="3000" value="850" oninput="this.value=Math.min(this.max,Math.max(this.min,this.value));this.form.payloadMassSlider.value=this.value;payloadMassChangeFunction(this.value);" style="position:absolute; top:262px; left:561px; border: 1px solid #00508a;"/>
      </form>
      <select id="payloadMassUnit" class="unitdropdown" style="position:absolute; top:259px; left:660px" oninput="payloadMassUnitChangeFunction();">
        <option value="kg">kg</option>
        <option value="t" selected>t</option>
      </select>
  </div>
  <div class="payloadMassLabel" z-index: 1; style="position:absolute; top:304px; left:552px; font-family: Garamond, serif; font-size: 14px; color: #757575;">
    Payload Mass
  </div>
    <canvas id="VehicleCanvas"></canvas>
    <canvas id="DVMapCanvas"></canvas>
  <div>
    <form id="DVmapButtons">
    </form>
  </div>
      
    <div id="tooltip"></div>
  <div style="position:absolute; top:1175px; left: 25px; width: 840px; margin: auto;border: 1px solid #fff; font-family: Helvetica, serif; font-size: 13px; color: #757575;text-align:center">
Click a starting point on the Delta-V map to predict the range of paths achievable by the above rocket engine and vehicle configuration, travelling between the major bodies of the Solar System and significant orbit points. Default start: Earth.
<br>
<br>
Note: This Delta-V budget map does not take rocket-staging into account, nor does it facilitate boosters (hence why some of the presets fail to lift off from earth when in reality they are able to). The calculation also doesn't account for ISP variation with ambient pressure, so atmospheres of destinations/origins don't alter the engine performance like they would in real life. It also assumes that at each subsequent waypoint after the original launch point, the vehicle has a sufficient thrust to weight ratio (TWR) to lift off again.
  </div>
  <div>
    <label for="enginePresetList" style="position:absolute;top:30px;left:55px;font-family:Garamond,serif;font-size:16px;color:#757575;">Engine Preset:</label>
    <select name="enginePresetList" id="enginePresetList" style="position:absolute;top:28px;left:160px;width:335px;font-family:Garamond,serif;font-size:14px;color:#00508a;"onchange="enginePresetChange(this.value);">
      <option value="custom">Custom</option>
      <option value="saturnv">Rocketdyne F-1, Saturn V 1st Stage (LOX + RP-1)</option>
      <option value="falcon9">Merlin 1D, Falcon 9 1st Stage (LOX + RP-1)</option>
      <option value="ariane5">Vulcain 2, Ariane 5/6 Core Stage (LOX + LH2)</option>
      <option value="soyuz2">RD-107A (Soyuz-2 1st Stage, LOX + Kerosene)</option>
      <option value="autophage">Autophage hybrid prototype (N2H4O3 + C2H4)</option>
    </select>
  </div>
    <label for="ISPFexponent" style="position:absolute;top:18px;left:652px;font-family:Garamond,serif;font-size:14px;color:#757575;">ISP-Thrust Tradeoff:</label>
      <form style="position:absolute;top:15px;left:772px;width:335px;font-family:Garamond,serif;font-size:13px;color:#00508a;">

    <label for="exp-relaxed">
      <input
        type="radio"
        id="exp-relaxed"
        name="ISPFexponent"
        value="1.8">
      Relaxed
    </label>
    <br>

    <label for="exp-nominal">
      <input
        type="radio"
        id="exp-nominal"
        name="ISPFexponent"
        value="2.1"
        checked>
      Realistic
    </label>
    <br>

    <label for="exp-punishing">
      <input
        type="radio"
        id="exp-punishing"
        name="ISPFexponent"
        value="2.5">
      Punishing
    </label>

</form>
      <label for="AerobrakeOption" style="position:absolute;top:275px;left:710px;text-align:right;font-family:Garamond,serif;font-size:12px;color:#757575;">Aerobraking<br>availability:</label>
      <form style="position:absolute;top:258px;left:772px;width:335px;font-family:Garamond,serif;font-size:12px;color:#00508a;">

    <label for="ABoff">
      <input
        type="radio"
        id="ABoff"
        name="aerobrakeoption"
        value="0">
      None
    </label>
    <br>

    <label for="ABdirect">
      <input
        type="radio"
        id="ABdirect"
        name="aerobrakeoption"
        value="1"
        checked>
        Landing Only
    </label>
    <br>

    <label for="ABindirect">
      <input
        type="radio"
        id="ABindirect"
        name="aerobrakeoption"
        value="2">
        Any Available
    </label>

</form>

      <script src="https://d3js.org/d3.v7.min.js"></script>
    <script type="text/javascript">
      var ISPslider = document.getElementById("ISPslider");
      ISPslider.style.top = "85px";
      ISPslider.style.left = "488px";
      ISPslider.style.width = "200px";
      var ISPinput = document.getElementById("ISPinput");
      ISPinput.style.top = "65px";
      ISPinput.style.left = 200+322+35 + "px";
      ISPinput.style.width = 75+ "px";
      ISPinput.style.border = "1px solid #00508a";
      var FSlider = document.getElementById("FSlider");
      FSlider.style.top = "85px";
      FSlider.style.left = "238px";
      FSlider.style.width = "200px";
      //DtSlider.style.oninput = DtChangeFunction(DtSlider.value);
      var FInput = document.getElementById("FInput");
      FInput.style.top = "65px";
      FInput.style.left = 200+95 + "px";
      FInput.style.width = 100+ "px";
      FInput.style.border = "1px solid #00508a";
      var vcan = document.getElementById('VehicleCanvas');
      vcan.style.position = 'absolute';
      vcan.style.top = "130px";
      vcan.style.left = "25px";
      var dcan = document.getElementById('DVMapCanvas');
      dcan.style.position = 'absolute';
      dcan.style.top = "322px";
      dcan.style.left = "25px";
      ////comment the following out before inserting to site
      
      enginePresetList.value = "saturnv";
      globals = [];
      globals['ISP'] = 254.77;
      globals['F'] = 5.9056e+6;
      
      globals['engineNo'] = 5;
      globals['fuelmass'] = 2077e3;
      globals['payloadmass'] = 850e3;
      globals['enginemass'] = 8e3;
      
      globals['select'] = 0;
      globals['dv'] = 15.3;
      globals['twr'] = 1.4;
      
      function getPDV() {
                    let XXX = NaN;

                    function buildPDV(bodies, links) {
                      const n = bodies.length;

                      const pdv = Array.from({ length: n }, () =>
                        Array(n).fill(NaN)
                      );

                      const index = Object.fromEntries(
                        bodies.map((b, i) => [b, i])
                      );
                      
                      // diagonals
                      for (let i = 0; i < n; i++) pdv[i][i] = XXX;
                      
                      let aerobrakeAvailability = Number(document.querySelector('input[name="aerobrakeoption"]:checked').value);
                      console.log(aerobrakeAvailability)
                      for (const [a, b, ab, ba, X] of links) {
                        const i = index[a];
                        const j = index[b];
                        //pdv[i][j] = ab;
                        //pdv[j][i] = ba ?? ab; // symmetric if not provided
                        const ABtype = X ?? "_";
                        console.log(ABtype)
                        if (aerobrakeAvailability == 0){
                          let abm = Math.max(ab,ba ?? ab);
                          pdv[i][j] = abm;
                          pdv[j][i] = abm;
                        }else if (aerobrakeAvailability == 1){
                          
                          if (ABtype == "X"){
                            pdv[i][j] = ab;
                            pdv[j][i] = ba ?? ab; // symmetric if not provided
                          }else{
                            let abm = Math.max(ab,ba ?? ab);
                            pdv[i][j] = abm;
                            pdv[j][i] = abm;
                          };
                          
                        }else if (aerobrakeAvailability == 2){
                          pdv[i][j] = ab;
                          pdv[j][i] = ba ?? ab; // symmetric if not provided
                        }
                        //*/
                      };

                      return pdv;
                    }
                    
                    //---
                    
                    const bodies = [
                    "ETH","LEO","GTO","GEO","L45","EC3","LUO","LUN",
                    "MTR","MC3","DTR","DEI","PTR","PHO","LMO","MAR",
                    "VTR","VC3","LVO","VEN",
                    "MeT","MeC","LMe","MER",
                    "LSO","SUN",
                    "CeT","CeO","CER",
                    "JupiterTr","JupiterC3","CaTr","CaO","Cal","GanTr","GanO","Gany","EuTr","EuO","Eur","IoTr","IoO","Io","JupLO","Jupiter"
                    ];
                    const links = [
                    // ----- Earth chain -----
                    ["ETH","LEO",9.3,2.0,"X"],
                    ["LEO","GTO",2.5,0.3],
                    ["LEO","GEO",3.8,0.3],
                    ["LEO","L45",4.1,0.3],
                    ["GTO","GEO",1.6],
                    ["GTO","EC3",0.7],
                    ["GTO","LUO",1.6,0.5],
                    ["LUO","LUN",1.6],
                    // ----- Mars chain -----
                    ["EC3","MTR",0.6,0.3],
                    ["MTR","MC3",0.3,0.9],
                    ["MC3","DTR",0.1,0.3],
                    ["DTR","DEI",0.7],
                    ["DTR","PTR",0.4],
                    ["PTR","PHO",0.5],
                    ["PTR","LMO",0.5,0.9],
                    ["LMO","MAR",2.0,4.1,"X"],
                    // ----- Venus chain -----
                    ["EC3","VTR",0.3,0.1],
                    ["VTR","VC3",0.2,0.4],
                    ["VC3","LVO",0.4,2.9],
                    ["LVO","VEN",1.0,29.7,"X"],
                    // ----- Mercury chain -----
                    ["VTR","MeT",2.1,0.3],
                    ["MeT","MeC",6.3],
                    ["MeC","LMe",1.2],
                    ["LMe","MER",3.1],
                    // ----- Solar -----
                    ["MeT","LSO",15.7,1.8],
                    ["LSO","SUN",178],
                    // ----- Ceres chain -----
                    ["MTR","CeT",1.3,0.4],
                    ["CeT","CeO",4.8],
                    ["CeO","CER",0.4],
                    // ----- Jupiter chain -----
                    ["CeT","JupiterTr",1.4,0.5],
                    ["JupiterTr","JupiterC3",0.1,0.3],
                    ["JupiterC3","CaTr",0.4,1.1],
                    ["CaTr","CaO",4.7],
                    ["CaO","Cal",1.75],
                    ["CaTr","GanTr",0.3,0.8],
                    ["GanTr","GanO",5.6],
                    ["GanO","Gany",1.9],
                    ["GanTr","EuTr",0.4,1.1],
                    ["EuTr","EuO",6.5],
                    ["EuO","Eur",1.4],
                    ["EuTr","IoTr",0.6,1.6],
                    ["IoTr","IoO",6.5],
                    ["IoO","Io",1.8],
                    ["IoTr","JupLO",0.3,12.7],
                    ["JupLO","Jupiter",1.0,33.1,"X"],
                    ];
        
                    let pdv = buildPDV(bodies, links);
                    
                    // node positions
                    let p = [
                      [0,0, 'Earth','N','Earth','Our Planet!',             0,0], //ETH
                      [0,0,'LEO', 'W','LEO','Low Earth Orbit',             0,0.40], //LEO
                      [0,0,'GTO', 'E','GTO','Geostationary Transfer Orbit',0.24,0.40], //GTO
                      [0,0,'GEO','N','GEO','Geostationary Orbit',          0.17,0.23], //GEO
                      [0,0,'L4L5','N','L4,L5','Stable Lagrange Points',-0.17,0.23], //L45
                      [0,0,'EC3','E','Earth C3','Earth Capture/Escape',0.12,0.57],
                      [0,0,'LUO','E','LLO','Low Lunar Orbit',0.30,0.23], //LUO
                      [0,0,'Moon','E','The Moon','The Moon (of Earth)',0.30,0.05], //LUN
                      [0,0,'MTR','S','Mars Tr.','Mars Transfer',0.25,0.72], //MTR
                      [0,0,'MC3','E','Mars C3','Mars Capture/Escape',0.42,0.57], //MC3
                      [0,0,'DTR','W',' ','Deimos Transfer',0.49,0.45], //DTR
                      [0,0,'DEI','N','Deimos','Deimos (moon of Mars)',0.49,0.3],
                      [0,0,'PTR','S',' ','Phobos Transfer',0.65,0.45],
                      [0,0,'PHO','N','Phobos','Phobos (moon of Mars)',0.65,0.31],
                      [0,0,'LMO','E','Low Mars Orbit','Low Mars Orbit',0.825,0.265],
                      [0,0,'Mars','N','Mars','The Red Planet',0.825,0],
                      [0,0,'VTR','S','Venus Tr.','Venus Transfer',-0.04,0.65], //16
                      [0,0,'VC3','E','Venus C3','Venus Capture/Escape',-0.07,0.5], //17
                      [0,0,'LVO','S','Low Venus Orbit','Low Venus Orbit',-0.35,0.5], //18
                      [0,0,'Venus','N','Venus','The Planet Venus',-0.35,0], //19
                      [0,0,'MeTR','S','Mercury Tr.','Mercury Transfer',-0.3,0.74], //20
                      [0,0,'MeC3','W','Merc. C3','Mercury Capture/Escape',-0.6,0.47], //20
                      [0,0,'LowMeO','W','Low Merc. Orbit','Low Mercury Orbit',-0.60,0.225], //20
                      [0,0,'Mercury','N','Mercury','The Planet Mercury',-0.6,0], //20
                      [0,0,'LSO','W','Low Solar Orbit','Low Solar Orbit',-0.875,0.95],
                      [0,0,'TheSun','W','⠀\n⠀\nThe Sun','The Sun',-0.875,-0.075],
                      [0,0,'CeTr','E','Ceres Tr.','Ceres Transfer',0.5,0.75],
                      [0,0,'CeO','S',' ','Low Ceres Orbit',0.8,0.675],
                      [0,0,'Ceres','N','Ceres','The Dwarf Planet Ceres',0.8,0.52],
                      [0,0,'JupiterTr','S','Jupiter Tr.','Jupiter Transfer',0.471,0.975],
                      [0,0,'JupiterC3','E','Jupiter C3','Jupiter Capture/Escape',0.625,1.05-0.05],
                      [0,0,'CallistoTr','E','Callisto Tr.','Callisto Transfer',0.7575,1.3-.1-0.05],
                      [0,0,'CallistoOrb','E',' ','Low Callisto Orbit',.1+0.475,1.37-0.05],
                      [0,0,'Callisto','N','Callisto','Callisto (Moon of Jupiter)',.1+0.475,1.175-0.05],
                      [0,0,'GanymedeTr','E','Gany-mede Tr.','Ganymede Transfer',0.7+0.0275,1.45-.1-0.05],
                      [0,0,'GanymedeOrb','E',' ','Low Ganymede Orbit',.15+0.35,1.57-0.05],
                      [0,0,'Ganymede','W','Gany-mede','Ganymede (Moon of Jupiter)',.15+0.35,1.35-0.05],
                      [0,0,'EuropaTr','E','Europa Tr.','Europa Transfer',0.685,1.6-.1],
                      [0,0,'EuropaOrb','E',' ','Low Europa Orbit',.15+0.275,1.7-0.025],
                      [0,0,'Europa','N','Europa','Europa (Moon of Jupiter)',.15+0.275,1.5-0.025],
                      [0,0,'IoTr','E','Io Tr.','Io Transfer',0.6325,1.725],
                      [0,0,'IoOrb','E',' ','Low Io Orbit',.175+0.175,1.9-0.05],
                      [0,0,'Io','N','Io','Io (Moon of Jupiter)',.175+0.175,1.6+.05-0.05],
                      [0,0,'JupLO','S','Low Jovian Orbit','Low Orbit of Jupiter',.925,1.4],
                      [0,0,'Jupiter','N','Jupiter','The Planet Jupiter',.925,0.9-0.05],
                      ];
        
      return {
      XXX: XXX,
      pdv: pdv,
      p: p,
      };
      };
      
      const {XXX,pdv,p} = getPDV();
      
      function computeNodeLayout(pdv, p) {
          const MIN_D = 0;
          const MAX_D = 250;
          const SCALE = 20; // pixels per km/s (tune this)
          //
          const Strength = 1.0;
          const forceManyBodyStrength = -50;
          const distanceRepulsionStrength = 80;
          //
          const ITERATIONS = 100;

        function forceBoundingBox(width, height, padding = 20) {
          return function () {
          nodes.forEach(n => {
          // Only adjust free nodes (ignore pinned nodes)
          if (n.fx == null) {
          n.x = Math.max(padding, Math.min(width - padding, n.x));
          }
          if (n.fy == null) {
          n.y = Math.max(padding, Math.min(height - padding, n.y));
          }
          });
          };
          }
        
        function distanceRepulsion(nodes, minDistance, strength) {
        return (alpha) => {
        for (let i = 0; i < nodes.length; i++) {
        const n1 = nodes[i];
        for (let j = i + 1; j < nodes.length; j++) {
        const n2 = nodes[j];


        const dx = n1.x - n2.x;
        const dy = n1.y - n2.y;
        const dist = Math.sqrt(dx*dx + dy*dy) || 0.1;


        if (dist < minDistance) {
        const repulse = (minDistance - dist) / dist * strength * alpha;


        // push nodes apart proportionally
        const vx = dx * repulse;
        const vy = dy * repulse;
        n1.vx += vx;
        n1.vy += vy;
        n2.vx -= vx;
        n2.vy -= vy;
        }
        }
        }
        };
        }
        const nodes = p.map((node, i) => {
          
          
          
          const n = { id: i };


          // Pin Nodes
          if (Number.isFinite(p[i][6])){
            n.fx = 420+420*p[i][6];
          }
          if (Number.isFinite(p[i][7])){
            n.fy = 30+420*p[i][7];
          }
          if (!Number.isFinite(p[i][6]) && !Number.isFinite(p[i][7])){
            n.x = 420+30*Math.cos(4*2*Math.PI*i/(pdv.length));
            //n.vx = ndir*Math.pow(i*MIN_D,2);
            n.y = 30+20*i;
          }
          
          return n;
          });


          // Links from pdv
          const links = [];
          for (let i = 0; i < pdv.length; i++) {
          for (let j = i + 1; j < pdv[i].length; j++) {
            
          const a = pdv[i][j];
          const b = pdv[j][i];

          // choose the larger finite delta-v
          let dv = NaN;


          if (Number.isFinite(a) && Number.isFinite(b)) {
          dv = Math.max(a, b);
          } else if (Number.isFinite(a)) {
          dv = a;
          } else if (Number.isFinite(b)) {
          dv = b;
          }
          if (Number.isFinite(pdv[i][j])) {
          links.push({
          source: i,
          target: j,
          distance: Math.max(MIN_D,Math.min(MAX_D, (Math.max(0,Math.min(dv,15))* SCALE)))
          }); 
          }
          }
          }
          
          const sim = d3.forceSimulation(nodes)
          .force(
          "link",
          d3.forceLink(links)
          .id(d => d.id)
          .distance(d => d.distance)
          .strength(Strength)
          )
          .force("charge", d3.forceManyBody().strength(forceManyBodyStrength))
          //.force("center", d3.forceCenter(420, 420))
          .force("bounding", forceBoundingBox(840, 840, 30)) // <-- clamp
          .force("distanceRepel", distanceRepulsion(nodes, MIN_D, distanceRepulsionStrength))
          .stop();


          for (let i = 0; i < ITERATIONS; i++) sim.tick();

          //console.log(nodes.map(n => [n.x, n.y]));
          // Write positions back into p
          nodes.forEach((n, j) => {
          p[j][0] = n.x;
          p[j][1] = n.y;
          });
          console.log('simulation done')
          
      }
      
      computeNodeLayout(pdv, p);
      //p = data.p;
      //pdv = data.pdv;
      

                      const canvasTop = Number(DVMapCanvas.style.top.replace('px',''));
                      const canvasLeft = Number(DVMapCanvas.style.left.replace('px',''));
                     
                      p.forEach((q, i) => {
                        const container = document.getElementById("DVmapButtons");
                        
                        const btn = document.createElement("input");
                        btn.type = "radio";
                        btn.id = p[i][2] + '_button';
                        btn.name = "DVnodeButton";
                        btn.style.position="absolute";
                        btn.className = "checkmark";
                        btn.value = i;
                        if (i==0){
                        btn.checked="checked";
                        }else{
                        }
                        //btn.onchange="DVcheckchange(this.value)";
                        btn.addEventListener("change", function () {
                        DVcheckchange(this.value);
                        });
                        container.appendChild(btn);
                        const lbl = document.createElement("label");
                        lbl.id = p[i][2] + '_buttonLabel'
                        lbl.labelFor = btn.id;
                        lbl.htmlFor = btn.id;
                        lbl.className = "container";
                        lbl.textContent = p[i][4];
                        lbl.style.position="absolute";
                        //lbl.title = "Earth orbit option";
                        container.appendChild(lbl);
                        const LABEL_WIDTH = 30; // px – controls wrapping consistency
                        const LABEL_GAP = 0; // distance from button center
                     let xshift = -15.5;
                     let yshift = -13.5;
                      var lbly = 0;
                      var lblx = 0;
                      var align = "left";
                      switch (p[i][3]) {
                        case 'N':
                          lblx = 0;
                          lbly = +12.5;
                          align = 'center';
                          break;
                        case 'S':
                          lblx = 0;
                          lbly = -25;
                          align = 'center';
                          break;
                        case 'W':
                          lblx = -LABEL_GAP - LABEL_WIDTH;
                          lbly = -5;
                          align = 'right';
                          break;
                        case 'E':
                          lblx = LABEL_GAP+LABEL_WIDTH;
                          lbly = -5;
                          align = "left";
                          break;
                      }
                        
                      //if (!btn || !lbl || !p[i]) return;

                      btn.style.top = (p[i][1] + yshift + canvasTop) + 'px';
                      btn.style.left = (p[i][0] + xshift + canvasLeft) + 'px';
                      lbl.style.display = "inline-block";
                      lbl.style.width = LABEL_WIDTH + "px";
                      lbl.style.whiteSpace = "normal";
                      lbl.style.textAlign = align;
                      lbl.style.top = (p[i][1] + yshift - lbly + canvasTop) + 'px';
                      lbl.style.left = (p[i][0] + xshift + lblx + canvasLeft) + 'px';
                      
                      lbl.innerHTML = p[i][4];//+"\n"+"["+((p[i][0]-420)/420).toFixed(2).toString()+','+((p[i][1]-30)/420).toFixed(2).toString()+']';
                      
                      const tooltip = document.getElementById("tooltip");

                      lbl.addEventListener("mouseenter", e => {
                      tooltip.textContent = p[i][5];
                      tooltip.style.left = e.pageX + "px";
                      tooltip.style.top = e.pageY + "px";
                      tooltip.style.display = "block";
                      });

                      lbl.addEventListener("mouseleave", () => {
                      tooltip.style.display = "none";
                      });
                     
                      btn.addEventListener("mouseenter", e => {
                      tooltip.textContent = p[i][5];
                      tooltip.style.left = e.pageX + "px";
                      tooltip.style.top = e.pageY + "px";
                      tooltip.style.display = "block";
                      });

                      btn.addEventListener("mouseleave", () => {
                      tooltip.style.display = "none";
                      });  
                      });
      
      
      
      
      CalculateN();
      
      function enginePresetChange(value) {
        let EPchoice = value;
        if (EPchoice.includes("saturnv")) {
          //Saturn V 1st Stage (Rocketdyne F-1)
          FInput.value = 5.9056e+6;
          FInput.oninput();
          ISPinput.value = 254.77;
          ISPinput.oninput();
          //
          fuelMassUnit.value = 't';
          fuelMassUnit.oninput();
          payloadMassUnit.value = 't';
          payloadMassUnit.oninput();
          engMassUnit.value = 't';
          engMassUnit.oninput();
          fuelMassInput.value = 2077;
          fuelMassInput.oninput();
          payloadMassInput.value = 850;
          payloadMassInput.oninput();
          engMassInput.value = 8;
          engMassInput.oninput();
          engNoInput.value = 5;
          engNoInput.oninput();
          enginePresetList.value = "saturnv";
        }else if (EPchoice.includes("autophage")) {
          //Autophage
          FInput.value = 98.409;
          FInput.oninput();
          FInput.onchange();
          ISPinput.value = 178.96;
          ISPinput.oninput();
          //
          fuelMassUnit.value = 'kg';
          fuelMassUnit.oninput();
          payloadMassUnit.value = 'kg';
          payloadMassUnit.oninput();
          engMassUnit.value = 'kg';
          engMassUnit.oninput();
          fuelMassInput.value = 1;
          fuelMassInput.oninput();
          payloadMassInput.value = 1;
          payloadMassInput.oninput();
          engMassInput.value = 1;
          engMassInput.oninput();
          engNoInput.value = 1;
          engNoInput.oninput();
          enginePresetList.value = "autophage";
        } else if (EPchoice.includes("falcon9")) {
          //Falcon 9 1st Stage (Merlin 1D)
          FInput.value = 8.0972e+5;
          FInput.oninput();
          FInput.onchange();
          ISPinput.value = 281.47;
          ISPinput.oninput();
          //
          fuelMassUnit.value = 't';
          fuelMassUnit.oninput();
          payloadMassUnit.value = 't';
          payloadMassUnit.oninput();
          engMassUnit.value = 'kg';
          engMassUnit.oninput();
          fuelMassInput.value = 396;
          fuelMassInput.oninput();
          payloadMassInput.value = 153;
          payloadMassInput.oninput();
          engMassInput.value = 490;
          engMassInput.oninput();
          engNoInput.value = 9;
          engNoInput.oninput();
          enginePresetList.value = "falcon9";
        } else if (EPchoice.includes("ariane5")) {
          //Ariane 5/6 Core Stage (Vulcain 1 or 2?)
          FInput.value = 1.2926e+6;
          FInput.oninput();
          FInput.onchange();
          ISPinput.value = 328.07;
          ISPinput.oninput();
          //
          fuelMassUnit.value = 't';
          fuelMassUnit.oninput();
          payloadMassUnit.value = 't';
          payloadMassUnit.oninput();
          engMassUnit.value = 't';
          engMassUnit.oninput();
          fuelMassInput.value = 170;
          fuelMassInput.oninput();
          payloadMassInput.value = 607;
          payloadMassInput.oninput();
          engMassInput.value = 1.686;
          engMassInput.oninput();
          engNoInput.value = 1;
          engNoInput.oninput();
          enginePresetList.value = "ariane5";
        } else if (EPchoice.includes("soyuz2")) {
          //Soyuz-2 1st Stage (RD-107A)
          FInput.value = 2.1014e+5;
          FInput.oninput();
          FInput.onchange();
          ISPinput.value = 288.29;
          ISPinput.oninput();
          //
          fuelMassUnit.value = 't';
          fuelMassUnit.oninput();
          payloadMassUnit.value = 't';
          payloadMassUnit.oninput();
          engMassUnit.value = 't';
          engMassUnit.oninput();
          fuelMassInput.value = 154;
          fuelMassInput.oninput();
          payloadMassInput.value = 157.660;
          payloadMassInput.oninput();
          engMassInput.value = 1.190;
          engMassInput.oninput();
          engNoInput.value = 4;
          engNoInput.oninput();
          enginePresetList.value = "soyuz2";
        }else {
          enginePresetList.Value = "custom";
          CalculateN();
        }
      }
      
      function onExponentChange(event) {
        const value = event.target.value;
        console.log("Selected exponent:", value);
        ISPChangeFunction(ISPinput.value);
      }
      const ISPFradios = document.querySelectorAll('input[name="ISPFexponent"]');
      ISPFradios.forEach(radio =>
        radio.addEventListener("change", onExponentChange)
      );
      function onAeroChange(event) {
        const value = event.target.value;
        console.log("Selected aerobrakeoption:", value);
        CalculateN();
      }
      const Aeroradios = document.querySelectorAll('input[name="aerobrakeoption"]');
      Aeroradios.forEach(radio =>
        radio.addEventListener("change", onAeroChange)
      );

      
      function ISPChangeFunction(val) {
        globals['ISP'] = Number(val);
        let F = Math.pow(10,FSlider.value);
        let ISP_Thrust_Tradeoff = document.querySelector('input[name="ISPFexponent"]:checked').value;
        F = Math.min(F,6e13*Math.pow(Number(val),-ISP_Thrust_Tradeoff));
        FInput.value = F;
        globals['F'] = F;
        enginePresetList.value = "custom";
        CalculateN();
      }

      function FChangeFunction(val) {
        globals['F'] = Number(val);
        let ISP_Thrust_Tradeoff = document.querySelector('input[name="ISPFexponent"]:checked').value;
        let isp = Math.min(ISPslider.value,Math.pow(6e13 / globals['F'],1/ISP_Thrust_Tradeoff));
        ISPinput.value = isp;
        globals['ISP'] = isp;
        enginePresetList.value = "custom";
        CalculateN();
      }
      
      function engNoChangeFunction(val){
        globals['engineNo'] = Number(val);
        CalculateN();
      }
      function engMassChangeFunction(val){
        var emu = document.getElementById('engMassUnit').value;
        if (emu == "kg"){
          emu = 1;
        }else{
          emu = 1000;
        }
        globals['enginemass'] = Number(val)*emu;
        CalculateN();
      }
      function engMassUnitChangeFunction(val){
        var emv = document.getElementById('engMassSlider').value;
        engMassChangeFunction(emv);
      }
      function fuelMassChangeFunction(val){
        var fmu = document.getElementById('fuelMassUnit').value;
        if (fmu == "kg"){
          fmu = 1;
        }else{
          fmu = 1000;
        }
        globals['fuelmass'] = Number(val)*fmu;
        CalculateN();
      }
      function fuelMassUnitChangeFunction(val){
        var fmv = document.getElementById('fuelMassSlider').value;
        fuelMassChangeFunction(fmv);
      }
      function payloadMassChangeFunction(val){
        var pmu = document.getElementById('payloadMassUnit').value;
        if (pmu == "kg"){
          pmu = 1;
        }else{
          pmu = 1000;
        }
        globals['payloadmass'] = Number(val)*pmu;
        CalculateN();
      }
      function payloadMassUnitChangeFunction(val){
        var pmv = document.getElementById('payloadMassSlider').value;
        payloadMassChangeFunction(pmv);
      }
      
      function DVcheckchange(val){
        globals['select'] = val;
        CalculateN();
      }
//////////////////////////////////////////////////////
////////////CALCULATE NOZZLE//////////////////////////
//////////////////////////////////////////////////////
      function CalculateN() {
        
        let g0 = 9.80665;
        
        let F = globals['F'];//mdot * Ve + ((Pe - Ph) * Math.sqrt(Aratio * Astar) / Math.PI);
        
        let isp = globals['ISP'];
        
        if (isp < 0) {
          isp = 0;
        }
        
        ISP2output.textContent = isp.toPrecision(5).toString();
        FSlider.value = Math.log10(F);
        ISPslider.value = isp;
        /////////////////
        drawRVehicle();
        /////////////////
        let engineNo = globals['engineNo'];
        let fuelMass = globals['fuelmass'];
        let payloadMass = globals['payloadmass'];
        let engineMass = globals['enginemass']*engineNo;
        var localgrav
        localgrav = 0;
        
        if (globals['select'] == 0){
          localgrav = 9.80665; //earth
        }else if (globals['select'] == 7){
          localgrav = 1.625; //moon //7
        }else if (globals['select'] == 15){
          localgrav = 3.72076; //mars //16
        }else if (globals['select'] == 11){
          localgrav = 0.003; //deimos //12
        }else if (globals['select'] == 13){
          localgrav = 0.0057; //phobos //14
        }else if (globals['select'] == 19){
          localgrav = 8.87; //venus //19
        }else if (globals['select'] == 23){
          localgrav = 3.7; //mercury
        }else if (globals['select'] == 25){
          localgrav = 274; //sun
        }else if (globals['select'] == 28){
          localgrav = 0.27; //ceres
        }else if (globals['select'] == 33){
          localgrav = 1.235; //Callisto
        }else if (globals['select'] == 36){
          localgrav = 1.428; //Ganymede
        }else if (globals['select'] == 39){
          localgrav = 1.315; //Europa
        }else if (globals['select'] == 42){
          localgrav = 1.796; //Io
        }else if (globals['select'] == 44){
          localgrav = 24.5; //Jupiter
        }else {
          localgrav = 0;
        }
        
        let TotalThrust = F * engineNo;
        
        FTotaloutput.textContent = TotalThrust.toPrecision(5).toString();
        
        var TWR
        if (localgrav == 0) {
          TWR = '---';
          //$w('#TWRtext').text = TWR;
        TWRoutput.textContent = 'weightless';
          TWRoutput.style.fontWeight = 'normal';
          TWRoutput.style.fontSize = '14px';
        } else {
          TWR = TotalThrust / ((payloadMass + fuelMass + engineMass) * localgrav);
        TWRoutput.textContent = TWR.toPrecision(5).toString();
          TWRoutput.style.fontWeight = 'bold';
          TWRoutput.style.fontSize = '16px';
          //$w('#TWRtext').text = TWR.toPrecision(5).toString()
        };
        //delta V in km/s
        let deltaV = isp * g0 * Math.log((payloadMass + fuelMass + engineMass) / (payloadMass + engineMass)) / 1e3;
        DVoutput.textContent = deltaV.toPrecision(5).toString();
        //$w('#deltaVtext').text = deltaV.toPrecision(3).toString();
        globals['dv'] = deltaV;
        globals['twr'] = TWR;
        
        
        drawDVmap(); //$w("#htmlVehicle").postMessage([Dt,De,Ln,engineNo,fuelMass,payloadMass]);
        //computeDVmap_click();
      }
      /////////////////////////////////////////////////////////////////////////////
      ////////////////////////////DRAW NOZZLE//////////////////////////////////////
      /////////////////////////////////////////////////////////////////////////////
      
      
function drawRVehicle(){//triggered when msg recieved
  //console.log(DT);
  //do other stuff
  
  var canvas = document.getElementById('VehicleCanvas');
  if (canvas.getContext)
   {
    var context = canvas.getContext('2d');
     
    var xsize = 840;
    var ysize = 125;
    canvas.style.width = xsize + "px";
    canvas.style.height = ysize + "px";

    // Set actual size in memory (scaled to account for extra pixel density).
    var scale = 2;//window.devicePixelRatio; // Change to 1 on retina screens to see blurry canvas.
    canvas.width = Math.floor(xsize * scale);
    canvas.height = Math.floor(ysize * scale);
      

    // Normalize coordinate system to use css pixels.
    context.scale(scale, scale);
    
     
    // Reset the current path
    let cx = (canvas.width/scale)/2;
    let cy = (canvas.height/scale)/2;
    
    context.lineWidth = 1;
    context.clearRect(0, 0, canvas.width/scale, canvas.height/scale);
    context.beginPath();
    context.lineJoin = "round";
    context.moveTo(0,0);
    context.lineTo(canvas.width/scale,0);
    context.strokeStyle = '#00508a';
    context.stroke();
    ////
    context.beginPath();
    context.lineJoin = "round";
    context.moveTo(0,0);
    context.lineTo(0,canvas.height/scale);
    context.stroke();
    ////
    context.beginPath();
    context.lineJoin = "round";
    context.moveTo(canvas.width/scale,canvas.height/scale);
    context.lineTo(canvas.width/scale,0);
    context.stroke();
    ////
    context.beginPath();
    context.lineJoin = "round";
    context.moveTo(canvas.width/scale,canvas.height/scale);
    context.lineTo(0,canvas.height/scale);
    context.stroke();
    ////
    //
    let dt = 0.72;//globals['DT'];
    let dE = 2.53;//globals['DE'];
    let Ln = 2.49;//globals['LN'];
    
    //ratio for screen
    let Lnc = (Ln/(Ln+dE))*(canvas.width/scale)/10;
    let dEc = (dE/(Ln+dE))*(canvas.width/scale)/10;
    let dtc = (dt/(Ln+dE))*(canvas.width/scale)/10;

    let dty = cy-150;
    let dtxL = cx-dtc/2;
    let dtxR = cx+dtc/2;
    let dExL = -dEc/2;
    let dExR = +dEc/2;
    let dR = dEc/dtc;
     
    
    let fuelmass = globals['fuelmass'];
    let payloadmass = globals['payloadmass'];
    let wetmass = fuelmass+payloadmass;
    
    
    VehicleL = (canvas.width/scale)*0.5*Math.pow(wetmass/3120000,0.05);
    VehicleW = (canvas.height/scale)*0.065/Math.pow(wetmass/3120000,0.13);
    
    //Fuel Tank Dimensions
    let fuelW = VehicleW;//*1*payloadmass/wetmass;//*fuelmass/wetmass;
    let fuelL = VehicleL*1*fuelmass/wetmass;
    let fuelBx = cx-180+fuelL/5;
    
    context.beginPath();
    context.moveTo(fuelBx,cy+fuelW*.7)
    context.lineTo(fuelBx,cy)
    context.lineTo(fuelBx+fuelL,cy)
    context.lineTo(fuelBx+fuelL,cy+fuelW*.7)
    context.lineTo(fuelBx,cy+fuelW*.7)
    context.fillStyle = '#189ACA'
    context.fill()
    
    context.beginPath();
    context.moveTo(fuelBx,cy-fuelW*.7)
    context.lineTo(fuelBx,cy)
    context.lineTo(fuelBx+fuelL,cy)
    context.lineTo(fuelBx+fuelL,cy-fuelW*.7)
    context.lineTo(fuelBx,cy-fuelW*.7)
    context.fillStyle = '#a5d5f5'
    context.fill()
    
    context.beginPath();
    context.moveTo(fuelBx,cy+fuelW)
    context.lineTo(fuelBx,cy-fuelW)
    context.lineTo(fuelBx+fuelL,cy-fuelW)
    context.lineTo(fuelBx+fuelL,cy+fuelW)
    context.lineTo(fuelBx,cy+fuelW)
    context.strokeStyle = '#00508a';
    context.stroke();
    
    
    //Payload Dimensions
    let Pload1W = VehicleW*1;//*1*payloadmass/wetmass;
    let Pload1Bx = fuelBx+fuelL;
    let Pload1L = VehicleL*1*payloadmass/wetmass;
    
    
    context.lineWidth = 2;
    context.beginPath();
    context.moveTo(2+Pload1Bx,cy+Pload1W)
    context.lineTo(2+Pload1Bx,cy-Pload1W)
    context.lineTo(2+Pload1Bx+Pload1L/1,cy-Pload1W)
    context.lineTo(2+Pload1Bx+Pload1L/1,cy+Pload1W)
    context.lineTo(2+Pload1Bx,cy+Pload1W)
    context.strokeStyle = '#00508a';
    context.stroke();
    
    context.beginPath();
    context.moveTo(2+Pload1Bx,cy+Pload1W*.7)
    context.lineTo(2+Pload1Bx,cy-Pload1W*.7)
    context.lineTo(2+Pload1Bx+Pload1L/1,cy-Pload1W*.7)
    context.lineTo(2+Pload1Bx+Pload1L/1,cy+Pload1W*.7)
    context.lineTo(2+Pload1Bx,cy+Pload1W*.7)
    context.strokeStyle = '#ffffff';
    context.stroke();
    context.fillStyle = '#a5a5a5'; //2.76; 00508a
    context.fill();
     
    context.lineWidth = 1.5;
    context.beginPath();
    context.moveTo(2+Pload1Bx,cy+Pload1W)
    context.lineTo(2+Pload1Bx,cy-Pload1W)
    context.lineTo(2+Pload1Bx+Pload1L/1,cy-Pload1W)
    context.lineTo(2+Pload1Bx+Pload1L/1,cy+Pload1W)
    context.lineTo(2+Pload1Bx,cy+Pload1W)
    context.strokeStyle = '#00508a';
    context.stroke();
    
    context.lineWidth = 1;
    nL = Pload1L+(fuelL+Pload1L)/9;//2+Math.log(fuelmass/wetmass);
    //console.log(nL)
    //Pload1L*
    context.beginPath();
    context.moveTo(4+Pload1Bx+nL,cy+Pload1W/2)
    context.bezierCurveTo(4+Pload1Bx+nL,cy+Pload1W/2,4+Pload1Bx+nL+VehicleL/VehicleW,cy,4+Pload1Bx+nL,cy-Pload1W/2)
    context.lineTo(4+Pload1Bx+nL,cy-Pload1W/2)
    context.lineTo(4+Pload1Bx+Pload1L/1,cy-Pload1W)
    context.lineTo(4+Pload1Bx+Pload1L/1,cy+Pload1W)
    context.lineTo(4+Pload1Bx+nL,cy+Pload1W/2)
    context.strokeStyle = '#00508a';
    context.stroke();
    
    let engineBx = fuelBx-fuelW/3;
     
    context.beginPath();
    context.moveTo(engineBx,cy+fuelW)
    context.lineTo(engineBx,cy-fuelW)
    context.lineTo(fuelBx-2,cy-fuelW)
    context.lineTo(fuelBx-2,cy+fuelW)
    context.lineTo(engineBx,cy+fuelW)
    context.strokeStyle = '#00508a';
    context.stroke();
    
    let LL = 1;
    
    let ncx = cx/4.25;
    let nbk2L = .9*LL;
    let nbk1L = .85*LL;
    let nmidL = .8*LL;
    let nfd1L = .75*LL;
    let nfd2L = .7*LL;
    let nRdtW = LL*dtc/2000;
    let nRdEW = LL*dEc/2000;
     
    let engineNo = globals['engineNo'];
    if (engineNo == 1){
        engrad = 35;
        context.beginPath();
        context.ellipse(ncx, cy, 60, 60, 1, 0, 2*Math.PI)
        context.strokeStyle = '#757575';
        context.stroke();
        context.beginPath();
        context.ellipse(ncx, cy, engrad, engrad, 1, 0, 2*Math.PI)
        context.strokeStyle = '#00508a';
        context.stroke();
      
        let ecy = [cy];

        let eLfrac = [nmidL];

        for (i = 0; i < engineNo; i++) {

          context.beginPath()
          context.moveTo(engineBx,ecy[i]+fuelW*nRdtW*engrad)
          context.lineTo(engineBx-fuelW*eLfrac[i],ecy[i]+fuelW*nRdEW*engrad)
          context.lineTo(engineBx-fuelW*eLfrac[i],ecy[i]-fuelW*nRdEW*engrad)
          context.lineTo(engineBx,ecy[i]-fuelW*nRdtW*engrad)
          context.strokeStyle = '#ffffff'
          context.lineWidth = 2;
          context.stroke();
          context.fillStyle = '#00508a'
          context.fill()

        }
      
    }else if (engineNo == 2){
        engrad = 25;
        context.beginPath();
        context.ellipse(ncx, cy, 60, 60, 1, 0, 2*Math.PI)
        context.strokeStyle = '#757575';
        context.stroke();
        context.beginPath();
        context.ellipse(ncx, cy+engrad*1.1, engrad, engrad, 1, 0, 2*Math.PI)
        context.strokeStyle = '#00508a';
        context.stroke();
        context.beginPath();
        context.ellipse(ncx, cy-engrad*1.1, engrad, engrad, 1, 0, 2*Math.PI)
        context.stroke();
        
        let kf = 1.25;
      
        let ecy = [cy+fuelW/3*kf*1.1,
                  cy-fuelW/3*kf*1.1];

        let eLfrac = [nmidL,
                     nmidL];

        for (i = 0; i < engineNo; i++) {

          context.beginPath()
          context.moveTo(engineBx,ecy[i]+fuelW*nRdtW*engrad)
          context.lineTo(engineBx-fuelW*eLfrac[i],ecy[i]+fuelW*nRdEW*engrad)
          context.lineTo(engineBx-fuelW*eLfrac[i],ecy[i]-fuelW*nRdEW*engrad)
          context.lineTo(engineBx,ecy[i]-fuelW*nRdtW*engrad)
          context.strokeStyle = '#ffffff'
          context.lineWidth = 2;
          context.stroke();
          context.fillStyle = '#00508a'
          context.fill()

        }
      
     }else if (engineNo == 3){
        engrad = 23;
        context.beginPath();
        context.ellipse(ncx, cy, 60, 60, 1, 0, 2*Math.PI)
        context.strokeStyle = '#757575';
        context.stroke();
        context.beginPath();
        context.ellipse(ncx, cy-engrad*1.28, engrad, engrad, 1, 0, 2*Math.PI)
        context.strokeStyle = '#00508a';
        context.stroke();
        context.beginPath();
        context.ellipse(ncx+engrad*1.14, cy+engrad/Math.sqrt(2), engrad, engrad, 1, 0, 2*Math.PI)
        context.stroke();
        context.beginPath();
        context.ellipse(ncx-engrad*1.14, cy+engrad/Math.sqrt(2), engrad, engrad, 1, 0, 2*Math.PI)
        context.stroke();
       
        let kf = 1.19;
       
        let ecy = [cy+fuelW/3*kf*1/Math.sqrt(2),
                  cy-fuelW/3*kf*1.28,
                  cy+fuelW/3*kf*1/Math.sqrt(2)];

        let eLfrac = [nbk1L,
                     nmidL,
                     nfd1L];

        for (i = 0; i < engineNo; i++) {

          context.beginPath()
          context.moveTo(engineBx,ecy[i]+fuelW*nRdtW*engrad)
          context.lineTo(engineBx-fuelW*eLfrac[i],ecy[i]+fuelW*nRdEW*engrad)
          context.lineTo(engineBx-fuelW*eLfrac[i],ecy[i]-fuelW*nRdEW*engrad)
          context.lineTo(engineBx,ecy[i]-fuelW*nRdtW*engrad)
          context.strokeStyle = '#ffffff'
          context.lineWidth = 2;
          context.stroke();
          context.fillStyle = '#00508a'
          context.fill()

        }
       
     }else if (engineNo == 4){
        engrad = 20;
        context.beginPath();
        context.ellipse(ncx, cy, 60, 60, 1, 0, 2*Math.PI)
        context.strokeStyle = '#757575';
        context.stroke();
        context.beginPath();
        context.ellipse(ncx, cy+engrad*1.65, engrad, engrad, 1, 0, 2*Math.PI)
        context.strokeStyle = '#00508a';
        context.stroke();
        context.beginPath();
        context.ellipse(ncx, cy-engrad*1.65, engrad, engrad, 1, 0, 2*Math.PI)
        context.stroke();
        context.beginPath();
        context.ellipse(ncx+engrad*1.65, cy, engrad, engrad, 1, 0, 2*Math.PI)
        context.strokeStyle = '#00508a';
        context.stroke();
        context.beginPath();
        context.ellipse(ncx-engrad*1.65, cy, engrad, engrad, 1, 0, 2*Math.PI)
        context.stroke();
       
        let ecy = [cy,
                  cy+fuelW/3*1.65,
                  cy-fuelW/3*1.65,
                  cy];

        let eLfrac = [nbk1L,
                     nmidL,
                     nmidL,
                     nfd1L];

        for (i = 0; i < engineNo; i++) {

          context.beginPath()
          context.moveTo(engineBx,ecy[i]+fuelW*nRdtW*engrad)
          context.lineTo(engineBx-fuelW*eLfrac[i],ecy[i]+fuelW*nRdEW*engrad)
          context.lineTo(engineBx-fuelW*eLfrac[i],ecy[i]-fuelW*nRdEW*engrad)
          context.lineTo(engineBx,ecy[i]-fuelW*nRdtW*engrad)
          context.strokeStyle = '#ffffff'
          context.lineWidth = 2;
          context.stroke();
          context.fillStyle = '#00508a'
          context.fill()

        }
       
      }else if (engineNo == 5){
        engrad = 17;
        context.beginPath();
        context.ellipse(ncx, cy, 60, 60, 1, 0, 2*Math.PI)
        context.strokeStyle = '#757575';
        context.stroke();
        context.beginPath();
        context.ellipse(ncx-engrad*2.2/Math.sqrt(2), cy+engrad*2.2/Math.sqrt(2), engrad, engrad, 1, 0, 2*Math.PI)
        context.strokeStyle = '#00508a';
        context.stroke();
        context.beginPath();
        context.ellipse(ncx+engrad*2.2/Math.sqrt(2), cy+engrad*2.2/Math.sqrt(2), engrad, engrad, 1, 0, 2*Math.PI)
        context.stroke();
        context.beginPath();
        context.ellipse(ncx+engrad*2.2/Math.sqrt(2), cy-engrad*2.2/Math.sqrt(2), engrad, engrad, 1, 0, 2*Math.PI)
        context.strokeStyle = '#00508a';
        context.stroke();
        context.beginPath();
        context.ellipse(ncx-engrad*2.2/Math.sqrt(2), cy-engrad*2.2/Math.sqrt(2), engrad, engrad, 1, 0, 2*Math.PI)
        context.stroke();
        context.beginPath();
        context.ellipse(ncx, cy, engrad, engrad, 1, 0, 2*Math.PI)
        context.stroke();
        
        let kf = 1/1.14;

        let ecy = [cy-fuelW/3*kf*2.2/Math.sqrt(2),
                  cy+fuelW/3*kf*2.2/Math.sqrt(2),
                  cy,
                  cy-fuelW/3*kf*2.2/Math.sqrt(2),
                  cy+fuelW/3*kf*2.2/Math.sqrt(2)];

        let eLfrac = [nbk1L,
                     nbk1L,
                     nmidL,
                     nfd1L,
                     nfd1L];

        for (i = 0; i < engineNo; i++) {

          context.beginPath()
          context.moveTo(engineBx,ecy[i]+fuelW*nRdtW*engrad)
          context.lineTo(engineBx-fuelW*eLfrac[i],ecy[i]+fuelW*nRdEW*engrad)
          context.lineTo(engineBx-fuelW*eLfrac[i],ecy[i]-fuelW*nRdEW*engrad)
          context.lineTo(engineBx,ecy[i]-fuelW*nRdtW*engrad)
          context.strokeStyle = '#ffffff'
          context.lineWidth = 2;
          context.stroke();
          context.fillStyle = '#00508a'
          context.fill()

        }
      
      }else if (engineNo == 6){
        engrad = 28;
        context.beginPath();
        context.ellipse(ncx, cy, 60, 60, 1, 0, 2*Math.PI)
        context.strokeStyle = '#757575';
        context.stroke();
        context.beginPath();
        context.ellipse(ncx+engrad*2/Math.sqrt(3), cy+engrad*1.14/Math.sqrt(3), engrad*0.6, engrad*0.6, 1, 0, 2*Math.PI)
        context.strokeStyle = '#00508a';
        context.stroke();
        context.beginPath();
        context.ellipse(ncx-engrad*2/Math.sqrt(3), cy+engrad*1.14/Math.sqrt(3), engrad*0.6, engrad*0.6, 1, 0, 2*Math.PI)
        context.strokeStyle = '#00508a';
        context.stroke();
        context.beginPath();
        context.ellipse(ncx, cy-engrad*1.33, engrad*0.6, engrad*0.6, 1, 0, 2*Math.PI)
        context.strokeStyle = '#00508a';
        context.stroke();
        context.beginPath();
        context.ellipse(ncx, cy+engrad*1.33, engrad*0.6, engrad*0.6, 1, 0, 2*Math.PI)
        context.strokeStyle = '#00508a';
        context.stroke();
        context.beginPath();
        context.ellipse(ncx+engrad*2/Math.sqrt(3), cy-engrad*1.14/Math.sqrt(3), engrad*0.6, engrad*0.6, 1, 0, 2*Math.PI)
        context.strokeStyle = '#00508a';
        context.stroke();
        context.beginPath();
        context.ellipse(ncx-engrad*2/Math.sqrt(3), cy-engrad*1.14/Math.sqrt(3), engrad*0.6, engrad*0.6, 1, 0, 2*Math.PI)
        context.strokeStyle = '#00508a';
        context.stroke();
        
        let kf = 1.36;
        
        let ecy = [cy-fuelW/3*kf*1.14/Math.sqrt(3),
                  cy+fuelW/3*kf*1.14/Math.sqrt(3),
                  cy-fuelW/3*kf*1.33,
                  cy+fuelW/3*kf*1.33,
                  cy-fuelW/3*kf*1.14/Math.sqrt(3),
                  cy+fuelW/3*kf*1.14/Math.sqrt(3)];

        let eLfrac = [nbk1L,
                     nbk1L,
                     nmidL,
                     nmidL,
                     nfd1L,
                     nfd1L];

        for (i = 0; i < engineNo; i++) {

          context.beginPath()
          context.moveTo(engineBx,ecy[i]+fuelW*nRdtW*0.6*engrad)
          context.lineTo(engineBx-fuelW*eLfrac[i],ecy[i]+fuelW*nRdEW*0.6*engrad)
          context.lineTo(engineBx-fuelW*eLfrac[i],ecy[i]-fuelW*nRdEW*0.6*engrad)
          context.lineTo(engineBx,ecy[i]-fuelW*nRdtW*0.6*engrad)
          context.strokeStyle = '#ffffff'
          context.lineWidth = 2;
          context.stroke();
          context.fillStyle = '#00508a'
          context.fill()

        }
        
      }else if (engineNo == 7){
      engrad = 27;
        context.beginPath();
        context.ellipse(ncx, cy, 60, 60, 1, 0, 2*Math.PI)
        context.strokeStyle = '#757575';
        context.stroke();
      context.beginPath();
      context.ellipse(ncx-engrad*1.28, cy, engrad*0.6, engrad*0.6, 1, 0, 2*Math.PI)
      context.strokeStyle = '#00508a';
      context.stroke();
      context.beginPath();
      context.ellipse(ncx+engrad*1.14/Math.sqrt(3), cy+engrad*2/Math.sqrt(3), engrad*0.6, engrad*0.6, 1, 0, 2*Math.PI)
      context.stroke();
      context.beginPath();
      context.ellipse(ncx-engrad*1.14/Math.sqrt(3), cy+engrad*2/Math.sqrt(3), engrad*0.6, engrad*0.6, 1, 0, 2*Math.PI)
      context.stroke();
      context.beginPath();
      context.ellipse(ncx+engrad*1.28, cy, engrad*0.6, engrad*0.6, 1, 0, 2*Math.PI)
      context.strokeStyle = '#00508a';
      context.stroke();
      context.beginPath();
      context.ellipse(ncx+engrad*1.14/Math.sqrt(3), cy-engrad*2/Math.sqrt(3), engrad*0.6, engrad*0.6, 1, 0, 2*Math.PI)
      context.stroke();
      context.beginPath();
      context.ellipse(ncx-engrad*1.14/Math.sqrt(3), cy-engrad*2/Math.sqrt(3), engrad*0.6, engrad*0.6, 1, 0, 2*Math.PI)
      context.stroke();
      context.beginPath();
      context.ellipse(ncx, cy, engrad*0.6, engrad*0.6, 1, 0, 2*Math.PI)
      context.stroke();
        
        let kf = 2.4;
        
        let ecy = [cy,
                  cy-fuelW/3*kf*1.14/Math.sqrt(3),
                  cy+fuelW/3*kf*1.14/Math.sqrt(3),
                  cy,
                  cy+fuelW/3*kf*1.14/Math.sqrt(3),
                  cy-fuelW/3*kf*1.14/Math.sqrt(3),
                  cy];

        let eLfrac = [nbk2L,
                     nbk1L,
                     nbk1L,
                     nmidL,
                     nfd1L,
                     nfd1L,
                     nfd2L];

        for (i = 0; i < engineNo; i++) {

          context.beginPath()
          context.moveTo(engineBx,ecy[i]+fuelW*nRdtW*0.6*engrad)
          context.lineTo(engineBx-fuelW*eLfrac[i],ecy[i]+fuelW*nRdEW*0.6*engrad)
          context.lineTo(engineBx-fuelW*eLfrac[i],ecy[i]-fuelW*nRdEW*0.6*engrad)
          context.lineTo(engineBx,ecy[i]-fuelW*nRdtW*0.6*engrad)
          context.strokeStyle = '#ffffff'
          context.lineWidth = 2;
          context.stroke();
          context.fillStyle = '#00508a'
          context.fill()

        }
        
      }else if (engineNo == 8){
        engrad = 17;
        context.beginPath();
        context.ellipse(ncx, cy, 60, 60, 1, 0, 2*Math.PI)
        context.strokeStyle = '#757575';
        context.stroke();
        context.beginPath();
        context.ellipse(ncx, cy+engrad*2.5, engrad*0.85, engrad*0.85, 1, 0, 2*Math.PI)
        context.strokeStyle = '#00508a';
        context.stroke();
        context.beginPath();
        context.ellipse(ncx, cy-engrad*2.5, engrad*0.85, engrad*0.85, 1, 0, 2*Math.PI)
        context.stroke();
         context.beginPath();
        context.ellipse(ncx+engrad*2.5, cy, engrad*0.85, engrad*0.85, 1, 0, 2*Math.PI)
        context.strokeStyle = '#00508a';
        context.stroke();
        context.beginPath();
        context.ellipse(ncx-engrad*2.5, cy, engrad*0.85, engrad*0.85, 1, 0, 2*Math.PI)
        context.stroke();
        context.beginPath();
        context.ellipse(ncx-engrad*1.3/Math.sqrt(2), cy+engrad*1.3/Math.sqrt(2), engrad*0.85, engrad*0.85, 1, 0, 2*Math.PI)
        context.stroke();
        context.beginPath();
        context.ellipse(ncx-engrad*1.3/Math.sqrt(2), cy-engrad*1.3/Math.sqrt(2), engrad*0.85, engrad*0.85, 1, 0, 2*Math.PI)
        context.stroke();
        context.beginPath();
        context.ellipse(ncx+engrad*1.3/Math.sqrt(2), cy+engrad*1.3/Math.sqrt(2), engrad*0.85, engrad*0.85, 1, 0, 2*Math.PI)
        context.stroke();
        context.beginPath();
        context.ellipse(ncx+engrad*1.3/Math.sqrt(2), cy-engrad*1.3/Math.sqrt(2), engrad*0.85, engrad*0.85, 1, 0, 2*Math.PI)
        context.stroke();
        
        let kf = 1/1.18;
        
        let ecy = [cy,
                  cy-fuelW/3*kf*1.3/Math.sqrt(2),
                  cy+fuelW/3*kf*1.3/Math.sqrt(2),
                  cy+fuelW/3*kf*2.5,
                  cy-fuelW/3*kf*2.5,
                  cy-fuelW/3*kf*1.3/Math.sqrt(2),
                  cy+fuelW/3*kf*1.3/Math.sqrt(2),
                  cy];

        let eLfrac = [nbk2L,
                     nbk1L,
                     nbk1L,
                     nmidL,
                     nmidL,
                     nfd1L,
                     nfd1L,
                     nfd2L];

        for (i = 0; i < engineNo; i++) {

          context.beginPath()
          context.moveTo(engineBx,ecy[i]+fuelW*nRdtW*0.85*engrad)
          context.lineTo(engineBx-fuelW*eLfrac[i],ecy[i]+fuelW*nRdEW*0.85*engrad)
          context.lineTo(engineBx-fuelW*eLfrac[i],ecy[i]-fuelW*nRdEW*0.85*engrad)
          context.lineTo(engineBx,ecy[i]-fuelW*nRdtW*0.85*engrad)
          context.strokeStyle = '#ffffff'
          context.lineWidth = 2;
          context.stroke();
          context.fillStyle = '#00508a'
          context.fill()

        }
        
      }else if (engineNo == 9){
        engrad = 16;
        context.beginPath();
        context.ellipse(ncx, cy, 60, 60, 1, 0, 2*Math.PI)
        context.strokeStyle = '#757575';
        context.stroke();
        context.beginPath();
        context.ellipse(ncx, cy+engrad*2.5, engrad*0.9, engrad*0.9, 1, 0, 2*Math.PI)
        context.strokeStyle = '#00508a';
        context.stroke();
        context.beginPath();
        context.ellipse(ncx, cy-engrad*2.5, engrad*0.9, engrad*0.9, 1, 0, 2*Math.PI)
        context.stroke();
        context.beginPath();
        context.ellipse(ncx+engrad*2.5, cy, engrad*0.9, engrad*0.9, 1, 0, 2*Math.PI)
        context.strokeStyle = '#00508a';
        context.stroke();
        context.beginPath();
        context.ellipse(ncx-engrad*2.5, cy, engrad*0.9, engrad*0.9, 1, 0, 2*Math.PI)
        context.stroke();
        context.beginPath();
        context.ellipse(ncx-engrad*2.5/Math.sqrt(2), cy+engrad*2.5/Math.sqrt(2), engrad*0.9, engrad*0.9, 1, 0, 2*Math.PI)
        context.stroke();
        context.beginPath();
        context.ellipse(ncx-engrad*2.5/Math.sqrt(2), cy-engrad*2.5/Math.sqrt(2), engrad*0.9, engrad*0.9, 1, 0, 2*Math.PI)
        context.stroke();
        context.beginPath();
        context.ellipse(ncx+engrad*2.5/Math.sqrt(2), cy+engrad*2.5/Math.sqrt(2), engrad*0.9, engrad*0.9, 1, 0, 2*Math.PI)
        context.stroke();
        context.beginPath();
        context.ellipse(ncx+engrad*2.5/Math.sqrt(2), cy-engrad*2.5/Math.sqrt(2), engrad*0.9, engrad*0.9, 1, 0, 2*Math.PI)
        context.stroke();
        context.beginPath();
        context.ellipse(ncx, cy, engrad*0.95, engrad*0.95, 1, 0, 2*Math.PI)
        context.stroke();
        
        let kf = 1/1.28;
        
        let ecy = [cy,
                  cy-fuelW/3*kf*2.5/Math.sqrt(2),
                  cy+fuelW/3*kf*2.5/Math.sqrt(2),
                  cy+fuelW/3*kf*2.5,
                  cy,
                  cy-fuelW/3*kf*2.5,
                  cy-fuelW/3*kf*2.5/Math.sqrt(2),
                  cy+fuelW/3*kf*2.5/Math.sqrt(2),
                  cy];

        let eLfrac = [nbk2L,
                     nbk1L,
                     nbk1L,
                     nmidL,
                     nmidL,
                     nmidL,
                     nfd1L,
                     nfd1L,
                     nfd2L];

        for (i = 0; i < engineNo; i++) {

          context.beginPath()
          context.moveTo(engineBx,ecy[i]+fuelW*nRdtW*0.9*engrad)
          context.lineTo(engineBx-fuelW*eLfrac[i],ecy[i]+fuelW*nRdEW*0.9*engrad)
          context.lineTo(engineBx-fuelW*eLfrac[i],ecy[i]-fuelW*nRdEW*0.9*engrad)
          context.lineTo(engineBx,ecy[i]-fuelW*nRdtW*0.9*engrad)
          context.strokeStyle = '#ffffff'
          context.lineWidth = 2;
          context.stroke();
          context.fillStyle = '#00508a'
          context.fill()

        }
        
    }
    
    
     }
 }
 function drawDVmap(){//triggered when msg recieved
                  //do other stuff
                  
                  var canvas = document.getElementById('DVMapCanvas');
                  if (canvas.getContext)
                   {
                    var context = canvas.getContext('2d');
                     
                    var xsize = 840;
                    var ysize = 840;
                    canvas.style.width = xsize + "px";
                    canvas.style.height = ysize + "px";

                    // Set actual size in memory (scaled to account for extra pixel density).
                    var scale = 4;//window.devicePixelRatio; // Change to 1 on retina screens to see blurry canvas.
                    canvas.width = Math.floor(xsize * scale);
                    canvas.height = Math.floor(ysize * scale);
                      

                    // Normalize coordinate system to use css pixels.
                    context.scale(scale, scale);
                     
                     
                    // Reset the current path
                    let cx = (canvas.width/scale)/2;
                    let cy = (canvas.height/scale)/2;
                    
                    context.lineWidth = 1;
                    context.clearRect(0, 0, canvas.width/scale, canvas.height/scale);
                    context.beginPath();
                    context.lineJoin = "round";
                    context.moveTo(0,0);
                    context.lineTo(canvas.width/scale,0);
                    context.strokeStyle = '#00508a';
                    context.stroke();
                    ////
                    context.beginPath();
                    context.lineJoin = "round";
                    context.moveTo(0,0);
                    context.lineTo(0,canvas.height/scale);
                    context.stroke();
                    ////
                    context.beginPath();
                    context.lineJoin = "round";
                    context.moveTo(canvas.width/scale,canvas.height/scale);
                    context.lineTo(canvas.width/scale,0);
                    context.stroke();
                    ////
                    context.beginPath();
                    context.lineJoin = "round";
                    context.moveTo(canvas.width/scale,canvas.height/scale);
                    context.lineTo(0,canvas.height/scale);
                    context.stroke();
                    ////
                    //
                     
                    const {XXX,pdv,p_old} = getPDV();
                    let select = globals['select'];
                    let dv = globals['dv'];
                    let twr = globals['twr'];
                    //let XXX = NaN;
                    
                    function multvector(a,b){
                        return a.map((e,i) => e * b[i]);
                    }
                    function divvector(a,b){
                        return a.map((e,i) => e / b[i]);
                    }
                     
                     
                    // flags for enabling aero-braking?
                     
                   
                   // pshort: sort rows to ensure shortest distances are traveled along first.
                   var pdvrow
                   var indices
                   var pshort = new Array(p.length)
                   for (i = 0; i < p.length; i++) {
                    pdvrow = pdv[i].slice();
                    indices = new Array(p.length);
                    for (var j = 0; j < p.length; ++j) indices[j] = j;
                    indices.sort(function(a,b){
                        if( !isFinite(pdvrow[a]) && !isFinite(pdvrow[b]) ) {
                            return 0;
                        }
                        if( !isFinite(pdvrow[a]) ) {
                            return 1;
                        }
                        if( !isFinite(pdvrow[b]) ) {
                            return -1;
                        }
                        return pdvrow[a] < pdvrow[b] ? -1 : pdvrow[a] > pdvrow[b] ? 1 : 0;
                    });
                    pshort[i] = multvector(indices,divvector(pdvrow.sort(),pdvrow.sort()));
                   }
                   //console.log(pshort)
                     
                    //key
                                 let keybasewidth = 450*scale;
                                 let keybaseheight = 500*scale;
                                 context.font = "12px Baskerville";
                                 context.fillStyle = "grey";
                                 context.textAlign = "left";
                                 context.fillText("KEY: (node-to-node)",(0.05)*keybasewidth/scale, (1.01+0.007)*keybaseheight/scale);
                                 context.beginPath()
                                 context.moveTo(0.05*keybasewidth/scale,1.05*keybaseheight/scale)
                                 context.lineTo(0.1*keybasewidth/scale,1.05*keybaseheight/scale)
                                 context.strokeStyle = '#019aca';
                                 context.lineWidth = 2.5;//2
                                 context.stroke();
                                 context.font = "12px Baskerville";
                                 context.fillStyle = "grey";
                                 context.textAlign = "left";
                                 context.fillText("Partial Trip",(0.1+0.005)*keybasewidth/scale, (1.05+0.007)*keybaseheight/scale);
                                 context.beginPath()
                                 context.moveTo(0.05*keybasewidth/scale,1.09*keybaseheight/scale)
                                 context.lineTo(0.1*keybasewidth/scale,1.09*keybaseheight/scale)
                                 context.strokeStyle = '#00508a';
                                 context.lineWidth = 2.5;//2
                                 context.stroke();
                                 context.font = "12px Baskerville";
                                 context.fillStyle = "grey";
                                 context.textAlign = "left";
                                 context.fillText("One-Way Trip",(0.1+0.005)*keybasewidth/scale, (1.09+0.007)*keybaseheight/scale);
                                 context.beginPath()
                                 context.moveTo(0.05*keybasewidth/scale,1.13*keybaseheight/scale)
                                 context.lineTo(0.1*keybasewidth/scale,1.13*keybaseheight/scale)
                                 context.strokeStyle = '#6350f1';
                                 context.lineWidth = 2.5;//2
                                 context.stroke();
                                 context.font = "12px Baskerville";
                                 context.fillStyle = "grey";
                                 context.textAlign = "left";
                                 context.fillText("Return Trip (+)",(0.1+0.005)*keybasewidth/scale, (1.13+0.007)*keybaseheight/scale);
                                 context.beginPath();
                                 context.moveTo((0.04)*keybasewidth/scale, (0.99)*keybaseheight/scale);
                                 context.lineTo((0.04)*keybasewidth/scale, (1.15)*keybaseheight/scale);
                                 context.lineTo((0.28)*keybasewidth/scale, (1.15)*keybaseheight/scale);
                                 context.lineTo((0.28)*keybasewidth/scale, (0.99)*keybaseheight/scale);
                                 context.lineTo((0.04)*keybasewidth/scale, (0.99)*keybaseheight/scale);
                                 context.strokeStyle = "grey";
                                 context.lineWidth = 1;
                                 context.stroke();
                                 context.closePath();
                    
                     
                     
                    let pRad = 10.5;
                     
                     
                    // points
                    for (i = 0; i < p.length; i++) {
                        //plot(p(i,1),p(i,2),'x')
                        context.beginPath();
                        context.ellipse(p[i][0],p[i][1], pRad, pRad, 1, 0, 2*Math.PI)
                        context.strokeStyle = '#c0c0c0';
                        context.lineWidth = 3;
                        context.stroke();
                    }
                    
                    // lines
                     for (let i = 0; i < pdv.length; i++) {
  for (let j = i + 1; j < pdv[i].length; j++) {
    const dvAtoB = pdv[i][j];
    const dvBtoA = pdv[j][i];

    if (!Number.isFinite(dvAtoB) && !Number.isFinite(dvBtoA)) continue;

    const x1 = p[i][0], y1 = p[i][1];
    const x2 = p[j][0], y2 = p[j][1];

    // Draw the line
    context.beginPath();
    context.moveTo(x1, y1);
    context.lineTo(x2, y2);
    context.strokeStyle = '#c0c0c0';
    context.lineWidth = 2;
    context.stroke();

    // Vector along the line
    const dx = x2 - x1;
    const dy = y2 - y1;
    const len = Math.hypot(dx, dy);
    const ux = dx / len;
    const uy = dy / len;

    // Perpendicular vector for offset
    const px = -uy;
    const py = ux;

    // Midpoint of line
    const midX = (x1 + x2) / 2;
    const midY = (y1 + y2) / 2;

    context.font = '12px Arial';
    context.textAlign = 'center';
    context.textBaseline = 'middle';

    const bothFinite = Number.isFinite(dvAtoB) && Number.isFinite(dvBtoA);
    const equal = bothFinite && dvAtoB === dvBtoA;
    const offset = 12; // distance from the line

    if (equal || !Number.isFinite(dvBtoA)) {
      // Single value in gray
      context.fillStyle = '#c0c0c0';
      context.fillText(dvAtoB.toFixed(1), midX + px * offset, midY + py * offset);
    } else {
      const maxDV = Math.max(dvAtoB, dvBtoA);
      const minDV = Math.min(dvAtoB, dvBtoA);

      // Larger delta-v in gray above line
      context.fillStyle = '#c0c0c0';
      context.fillText(maxDV.toFixed(1), midX + px * offset, midY + py * offset);

      // Smaller delta-v in green below line
      context.fillStyle = 'lightgreen';
      context.fillText(minDV.toFixed(1), midX - px * offset, midY - py * offset);

      // Arrow along smaller delta-v
      const arrowLength = 10;
      let fromX, fromY, toX, toY;

      if (dvAtoB < dvBtoA) {
        fromX = x1; fromY = y1; toX = x2; toY = y2;
      } else {
        fromX = x2; fromY = y2; toX = x1; toY = y1;
      }

      const arrowDX = toX - fromX;
      const arrowDY = toY - fromY;
      const arrowLen = Math.hypot(arrowDX, arrowDY);
      const uxArrow = arrowDX / arrowLen;
      const uyArrow = arrowDY / arrowLen;

      const tipX = fromX + uxArrow * (arrowLen * 0.75);
      const tipY = fromY + uyArrow * (arrowLen * 0.75);

      const arrowAngle = Math.PI / 8;

      context.beginPath();
      context.moveTo(tipX, tipY);
      context.lineTo(
        tipX - arrowLength * (uxArrow * Math.cos(arrowAngle) + uyArrow * Math.sin(arrowAngle)),
        tipY - arrowLength * (uyArrow * Math.cos(arrowAngle) - uxArrow * Math.sin(arrowAngle))
      );
      context.lineTo(
        tipX - arrowLength * (uxArrow * Math.cos(arrowAngle) - uyArrow * Math.sin(arrowAngle)),
        tipY - arrowLength * (uyArrow * Math.cos(arrowAngle) + uxArrow * Math.sin(arrowAngle))
      );
      context.closePath();
      context.fillStyle = 'lightgreen';
      context.fill();
    }
  }
}
                    /*
                    for (i = 0; i < pdv.length; i++) {
                        for (j = 0; j < pdv[0].length; j++) {
                            if (!isNaN(pdv[i][j])) {
                              context.beginPath()
                              context.moveTo(p[i][0],p[i][1])
                              context.lineTo(p[j][0],p[j][1])
                              context.strokeStyle = '#c0c0c0'
                              context.lineWidth = 2;
                              context.stroke();
                            }
                        }
                    }
                    //*/
                     

                     
                     var N
                     let selectM = [select];
                     let dvR = [dv];
                     let RM = [];
                     let iS = [NaN];
                     let spdv = [];
                     let xpdv = [];
                     let xspdv = [];
                     let cspdv = [];
                     let sp = [];
                     let RMg = [];
                     let dvi = [];
                     let selectx = [];
                     let pvisits = pdv.map(() => 0);//[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
                     let completecol = '#00508a';
                     
                        context.font = "16px Baskerville";
                        context.fillStyle = "grey";
                        context.textAlign = "center";
                        context.fillText("More destinations coming soon!",(canvas.width/scale)*0.42, (canvas.height/scale)*0.7);
                     
                     if (twr <= 1){
                        context.font = "15px Baskerville";
                        context.fillStyle = "red";
                        context.textAlign = "right";
                        context.fillText("INSUFFICIENT TWR FOR LIFT-OFF!",(canvas.width/scale)/2+150, (canvas.height/scale)/2-100);
                        //context.fillText("insufficient for lift-off!",(canvas.width/scale)-100, 102);
                       
                       context.beginPath();
                       context.ellipse(p[select][0],p[select][1], pRad, pRad, 1, 0, 2*Math.PI)
                       context.strokeStyle = '#c50000';
                       context.lineWidth = 7;
                       context.stroke();
                     }else {
                       
                     while (dvR.length < pdv.length*pdv[0].length*2 && iS.length !=0){
                       spdv = [];
                       cspdv = [];
                       xpdv = [];
                       xspdv = [];
                       iS = [];
                       selectx = [];
                       N = 0;
                       
                       for (k = 0; k < selectM.length; k++){
                         selectx = selectM[k];
                         dvi = dvR[k];
                         
                         for (f = 0; f < pdv[selectx].length; f++){
                           spdv[f] = pdv[selectx][f]-dvi;
                         }
                         
                         xspdv = pshort[selectx];

                           for (i = 0; i < xspdv.length; i++){
                             N = xspdv[i];
                             if (spdv[N] <= 0){
                                 
                                 if (isNaN(pdv[N][selectx])){
                                        completecol = '#6350f1';
                                 }else{
                                        completecol = '#00508a';
                                 }
                                 
                               RMg = 0;
                               for (g = 0; g < RM.length; g++){
                                 if (RM[g] == selectx){
                                   RMg = RMg+1;
                                 }
                               }
                               if (RMg == 0){
                                 context.beginPath()
                                 context.moveTo(p[selectx][0],p[selectx][1])
                                 context.lineTo(p[N][0],p[N][1])
                                 context.strokeStyle = completecol;
                                 context.setLineDash([0])
                                 context.lineWidth = 2;
                                 context.stroke();

                                 context.beginPath();
                                 context.ellipse(p[N][0],p[N][1], pRad, pRad, 1, 0, 2*Math.PI)
                                 context.strokeStyle = completecol;
                                 context.lineWidth = 5;
                                 context.stroke();
                               
                                 pvisits[N] = pvisits[N]+1;
                                 pdv[selectx][N] = NaN;
                                 pshort[selectx][i] = NaN;

                                 iS.push(N)
                                 dvR.push(Math.abs(spdv[N]))
                               }
                               
                             }else if (!isNaN(spdv[N]) && pvisits[N] < 1){
                               //
                               pdiv = 1-(spdv[N]/pdv[selectx][N]);
                               //
                               RMg = 0;
                               for (g = 0; g < RM.length; g++){
                                 if (RM[g] == selectx){
                                   RMg = RMg+1;
                                 }
                               }
                               if (RMg == 0){
                                 let brdmgn = 2.5; //account for thickness
                                 let nodeA = [p[selectx][0],p[selectx][1]];
                                 let nodeB = [p[N][0],p[N][1]];
                                 let nodeSep = [nodeB[0]-nodeA[0],nodeB[1]-nodeA[1]];
                                 
                                 let node_angle = Math.atan2(nodeSep[1],nodeSep[0]);
                                 nodeA = [nodeA[0]+(pRad+brdmgn)*Math.cos(node_angle),nodeA[1]+(pRad+brdmgn)*Math.sin(node_angle)]
                                 nodeB = [nodeB[0]+(pRad+brdmgn)*Math.cos(Math.PI+node_angle),nodeB[1]+(pRad+brdmgn)*Math.sin(Math.PI+node_angle)]
                                 
                                 nodeSep = [nodeB[0]-nodeA[0],nodeB[1]-nodeA[1]];
                                 
                                 context.beginPath()
                                 context.moveTo(nodeA[0],nodeA[1])
                                 context.lineTo(nodeA[0]+nodeSep[0]*pdiv,nodeA[1]+nodeSep[1]*pdiv)
                                 
                                 context.strokeStyle = '#00c0fa'
                                 //context.setLineDash([3, 3])
                                 context.lineWidth = 2;
                                 context.stroke();
                               }

                             }
                         }
                       }
                        RM.push(selectx);
                        if (dvR.length < 2){
                            dvR.push(0);
                        }
                        if (iS.length > 0){
                          for (g = 0; g < iS.length; g++){
                            selectM.push(iS[g]);
                          }
                        }
                     } //end of while loop
                       
                       // highlight start point ring
                       context.beginPath();
                       context.ellipse(p[select][0],p[select][1], pRad, pRad, 1, 0, 2*Math.PI)
                       context.strokeStyle = '#00908a';
                       context.lineWidth = 5;
                       context.stroke();
                     }
                     
                       for (i = 0; i < p.length; i++){
                       context.beginPath();
                       context.ellipse(p[i][0],p[i][1], pRad, pRad, 1, 0, 2*Math.PI)
                       context.fillStyle = '#ffffff';
                       context.fill();
                       }
                     
                       context.beginPath();
                       context.ellipse(p[select][0],p[select][1], pRad/2.5, pRad/2.5, 1, 0, 2*Math.PI)
                       context.fillStyle = '#00508a';
                       context.fill();
                     //console.log(pvisits)
                     context.restore;
                     }
                 }
      
    </script>
</body>

</html>
