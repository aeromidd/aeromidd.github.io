 <!DOCTYPE html>
<html>
<head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width">
      <title>LinSub</title>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/3.2.1/math.js">
</script>
  <style>
    table, th, td {
  border: 0.5px solid #00508a;
}
  </style>
</head>
<body>
<canvas id="BorderCanvas"></canvas>
      <script type="text/javascript">
         var canvas = document.getElementById('BorderCanvas');
         if (canvas.getContext) {
           var context = canvas.getContext('2d');
           var xsize = 880;
           var ysize = 1200;
           canvas.style.width = xsize + "px";
           canvas.style.height = ysize + "px";
           // Set actual size in memory (scaled to account for extra pixel density).
           var scale = 2; //window.devicePixelRatio; // Change to 1 on retina screens to see blurry canvas.
           canvas.width = Math.floor(xsize * scale);
           canvas.height = Math.floor(ysize * scale);
           // Normalize coordinate system to use css pixels.
           context.scale(scale, scale);
           context.clearRect(0, 0, canvas.width / scale, canvas.height / scale);
           context.beginPath();
           context.lineJoin = "round";
           context.moveTo(0, 0);
           context.lineTo(canvas.width / scale, 0);
           context.strokeStyle = '#00508a';
           context.stroke();
           ////
           context.beginPath();
           context.lineJoin = "round";
           context.moveTo(0, 0);
           context.lineTo(0, canvas.height / scale);
           context.stroke();
           ////
           context.beginPath();
           context.lineJoin = "round";
           context.moveTo(canvas.width / scale, canvas.height / scale);
           context.lineTo(canvas.width / scale, 0);
           context.stroke();
           ////
           context.beginPath();
           context.lineJoin = "round";
           context.moveTo(canvas.width / scale, canvas.height / scale);
           context.lineTo(0, canvas.height / scale);
           context.stroke();
           ////
         }
      </script>
A/Z: manual sternplane | K/M: manual bowplane | T: toggle depth autopilot | I = reset integrators
<br>
Click: depth setpoint | P/L: steady pitch setpoint | O: reset steady pitch
<br>
C: toggle compressibility | V: toggle active trim compensator | B: toggle trim target
<br>
S = fix/unfix seastate | 0-9 = set seastate | R = reset simulation
<br>
<canvas id="BlurredSimCanvas" tabindex='0'></canvas>
<canvas id="SimCanvas" tabindex='0' style="position:absolute;top:40px;left:15px;"></canvas>
<div class="slidecontainer">
  <input type="range" min="0" max="10" step="1" value="1" class="slider" id="SimSpeedSlider" style="position:absolute; left:650px; top:50px; width: 120px;" oninput="this.nextElementSibling.value = this.value +'x'">
<output style="position:absolute; left:775px; top:50px;" >1x</output>
</div>
<table id="AftPlaneGainsTable" style="position:absolute; left:15px; top:190px; display:none">
<tr>
  <td style="width:45px;text-align:center;font-family:'Garamond';font-size: 14px;background:#00508a;color:#ffffff">Sternplane Control</td>
  <td style="width:45px;text-align:center">P</td>
  <td style="width:45px;text-align:center">I</td>
  <td style="width:45px;text-align:center">D</td>
</tr>
<tr>
  <td style="width:45px;text-align:center;font-family:'Garamond';font-size: 14px;">Depth</td>
  <td><input id="ctrlds_zP" value="0.0" step="0.01" type="number" style="width:45px;text-align:right" onkeypress="return isNumberKey(event)"/></td>
  <td><input id="ctrlds_zI" value="0.0" step="0.01" type="number" style="width:45px;text-align:right" onkeypress="return isNumberKey(event)"/></td>
  <td><input id="ctrlds_zD" value="-0.9" step="0.01" type="number" style="width:45px;text-align:right" onkeypress="return isNumberKey(event)"/></td>
</tr>
<tr>
  <td style="width:45px;text-align:center;font-family:'Garamond';font-size: 14px;">Pitch</td>
  <td><input id="ctrlds_thtP" value="-26.0" step="0.01" type="number" style="width:45px;text-align:right" onkeypress="return isNumberKey(event)"/></td>
  <td><input id="ctrlds_thtI" value="-0.12" step="0.01" type="number" style="width:45px;text-align:right" onkeypress="return isNumberKey(event)"/></td>
  <td><input id="ctrlds_thtD" value="-21.0" step="0.01" type="number" style="width:45px;text-align:right" onkeypress="return isNumberKey(event)"/></td>
</tr>
</table>
  
  <table id="FwdPlaneGainsTable" style="position:absolute; left:641px; top:190px; display:none">
<tr>
  <td style="width:45px;text-align:center">P</td>
  <td style="width:45px;text-align:center">I</td>
  <td style="width:45px;text-align:center">D</td>
  <td style="width:45px;text-align:center;font-family:'Garamond';font-size: 14px;background:#00508a;color:#ffffff">Bowplane Control</td>
</tr>
<tr>
  <td><input id="ctrldb_zP" value="-0.4" step="0.01" type="number" style="width:45px;text-align:right" onkeypress="return isNumberKey(event)"/></td>
  <td><input id="ctrldb_zI" value="0.0" step="0.01" type="number" style="width:45px;text-align:right" onkeypress="return isNumberKey(event)"/></td>
  <td><input id="ctrldb_zD" value="-1.2" step="0.01" type="number" style="width:45px;text-align:right" onkeypress="return isNumberKey(event)"/></td>
  <td style="width:45px;text-align:center;font-family:'Garamond';font-size: 14px;">Depth</td>
</tr>
<tr>
  <td><input id="ctrldb_thtP" value="8.0" step="0.01" type="number" style="width:45px;text-align:right" onkeypress="return isNumberKey(event)"/></td>
  <td><input id="ctrldb_thtI" value="-0.03" step="0.01" type="number" style="width:45px;text-align:right" onkeypress="return isNumberKey(event)"/></td>
  <td><input id="ctrldb_thtD" value="7.9" step="0.01" type="number" style="width:45px;text-align:right" onkeypress="return isNumberKey(event)"/></td>
  <td style="width:45px;text-align:center;font-family:'Garamond';font-size: 14px;">Pitch</td>
</tr>
</table>

<table id="PlantPhysicsTable" style="position:absolute; left:15px; top:380px; display:none">
<tr>
  <td colspan="2" style="width:163px;text-align:center;font-family:'Garamond';font-size: 14px;background:#00508a;color:#ffffff">Submarine Plant</td>
</tr>
<tr>
  <td colspan="2" style="width:163px;text-align:center;font-family:'Garamond';font-size: 14px;font-weight:bold;">Vehicle Particulars</td>
  </td>
</tr>
<tr>
  <td style="width:120px;text-align:center;font-family:'Garamond';font-size: 14px;">Seawater Density [kg/m³]</td>
  <td><input id="Plant_rho" value="1030.0" step="1" type="number" style="width:60px;text-align:right" onkeypress="return isNumberKey(event)"/></td>
</tr>
<tr>
  <td style="width:163px;text-align:center;font-family:'Garamond';font-size: 14px;">Hull Length [m]</td>
  <td><input id="Plant_L" value="75.0" step="1" type="number" style="width:60px;text-align:right" onkeypress="return isNumberKey(event)"/></td>
</tr>
<tr>
  <td style="width:163px;text-align:center;font-family:'Garamond';font-size: 14px;">Hull Radius [m]</td>
  <td><input id="Plant_r" value="5.0" step="0.1" type="number" style="width:60px;text-align:right" onkeypress="return isNumberKey(event)"/></td>
</tr>
<tr>
  <td style="width:163px;text-align:center;font-family:'Garamond';font-size: 14px;">Mass [t]</td>
  <td><input id="Plant_mass" value="1000.0" step="1" type="number" style="width:60px;text-align:right" onkeypress="return isNumberKey(event)"/></td>
</tr>
<tr>
  <td style="width:163px;text-align:center;font-family:'Garamond';font-size: 14px;">Vertical CoB [m]</td>
  <td><input id="Plant_zcb" value="-1.0" step="0.1" type="number" style="width:60px;text-align:right" onkeypress="return isNumberKey(event)"/></td>
</tr>
<tr>
  <td colspan="2" style="width:163px;text-align:center;font-family:'Garamond';font-size: 14px;font-weight:bold;">Hull Hydrodynamics*</td>
  </td>
</tr>
<tr>
  <td style="width:163px;text-align:center;font-family:'Garamond';font-size: 14px;">Z_Wdot [-]</td>
  <td><input id="Plant_Z_Wdot" value="-6.0" step="0.1" type="number" style="width:60px;text-align:right" onkeypress="return isNumberKey(event)"/></td>
</tr>
<tr>
  <td style="width:163px;text-align:center;font-family:'Garamond';font-size: 14px;">Z_Qdot [-]</td>
  <td><input id="Plant_Z_Qdot" value="-3.0" step="0.1" type="number" style="width:60px;text-align:right" onkeypress="return isNumberKey(event)"/></td>
</tr>
<tr>
  <td style="width:163px;text-align:center;font-family:'Garamond';font-size: 14px;">M_Wdot [-]</td>
  <td><input id="Plant_M_Wdot" value="-2.0" step="0.1" type="number" style="width:60px;text-align:right" onkeypress="return isNumberKey(event)"/></td>
</tr>
<tr>
  <td style="width:163px;text-align:center;font-family:'Garamond';font-size: 14px;">M_Qdot [-]</td>
  <td><input id="Plant_M_Qdot" value="-1.0" step="0.1" type="number" style="width:60px;text-align:right" onkeypress="return isNumberKey(event)"/></td>
</tr>
<tr>
  <td style="width:163px;text-align:center;font-family:'Garamond';font-size: 14px;">Z_UW [-]</td>
  <td><input id="Plant_Z_UW" value="-36.0" step="0.1" type="number" style="width:60px;text-align:right" onkeypress="return isNumberKey(event)"/></td>
</tr>
<tr>
  <td style="width:163px;text-align:center;font-family:'Garamond';font-size: 14px;">Z_UQ [-]</td>
  <td><input id="Plant_Z_UQ" value="-12.0" step="0.1" type="number" style="width:60px;text-align:right" onkeypress="return isNumberKey(event)"/></td>
</tr>
<tr>
  <td style="width:163px;text-align:center;font-family:'Garamond';font-size: 14px;">M_UW [-]</td>
  <td><input id="Plant_M_UW" value="3.0" step="0.1" type="number" style="width:60px;text-align:right" onkeypress="return isNumberKey(event)"/></td>
</tr>
<tr>
  <td style="width:163px;text-align:center;font-family:'Garamond';font-size: 14px;">M_UQ [-]</td>
  <td><input id="Plant_M_UQ" value="-12.0" step="0.1" type="number" style="width:60px;text-align:right" onkeypress="return isNumberKey(event)"/></td>
</tr>
<tr>
  <td colspan="2" style="width:163px;text-align:center;font-family:'Garamond';font-size: 14px;font-weight:bold;">Diveplane Hydrodynamics*</td>
  </td>
</tr>
<tr>
  <td style="width:163px;text-align:center;font-family:'Garamond';font-size: 14px;">Z_UU: Bow  [-]</td>
  <td><input id="Plant_Z_UUdb" value="-0.80" step="0.01" type="number" style="width:60px;text-align:right" onkeypress="return isNumberKey(event)"/></td>
</tr>
<tr>
  <td style="width:163px;text-align:center;font-family:'Garamond';font-size: 14px;">Z_UU: Stern [-]</td>
  <td><input id="Plant_Z_UUds" value="-1.00" step="0.01" type="number" style="width:60px;text-align:right" onkeypress="return isNumberKey(event)"/></td>
</tr>
<tr>
  <td style="width:163px;text-align:center;font-family:'Garamond';font-size: 14px;">M_UU: Bow [-]</td>
  <td><input id="Plant_M_UUdb" value="0.20" step="0.01" type="number" style="width:60px;text-align:right" onkeypress="return isNumberKey(event)"/></td>
</tr>
<tr>
  <td style="width:163px;text-align:center;font-family:'Garamond';font-size: 14px;">M_UU: Stern [-]</td>
  <td><input id="Plant_M_UUds" value="-0.30" step="0.01" type="number" style="width:60px;text-align:right" onkeypress="return isNumberKey(event)"/></td>
</tr>
</table>

<table id="CtrlSettingsTable" style="position:absolute; left:700px; top:450px; width:180px; display:none;">
<tr>
  <td colspan="2" style="width:163px;text-align:center;font-family:'Garamond';font-size: 14px;background:#00508a;color:#ffffff">Controller Settings</td>
</tr>
<tr>
  <td><input id="maxpitchInput" value="10.0" step="0.1" min="0" max="20" type="number" style="width:60px;text-align:right" onkeypress="return isNumberKey(event)"/></td>
  <td style="width:163px;text-align:center;font-family:'Garamond';font-size: 14px;">Max. Pitch Angle</td>
</tr>
<tr>
  <td><input id="UsePitchForDepthChangesInput" type="checkbox" style="width:60px;" checked>
  <td style="width:163px;text-align:center;font-family:'Garamond';font-size: 14px;">Use Pitch for Depth Changes</td>
</tr>
<tr>
  <td><input id="SliderControlMaintainPitchInput" type="checkbox" style="width:60px;" checked>
  <td style="width:163px;text-align:center;font-family:'Garamond';font-size: 14px;">Maintain Pitch During Slider Control</td>
</tr>
<tr>
  <td><input id="SliderControlRatioInput" value="-0.25" step="0.05" max="2.0" min="-2.0" type="number" style="width:60px;text-align:right" onkeypress="return isNumberKey(event)"/></td>
  <td style="width:163px;text-align:center;font-family:'Garamond';font-size: 14px;">Slider Control Sternplane Ratio</td>
</tr>
<tr>
  <td><input id="maxplanerateInput" value="15.0" step="0.1" type="number" style="width:60px;text-align:right" onkeypress="return isNumberKey(event)"/></td>
  <td style="width:163px;text-align:center;font-family:'Garamond';font-size: 14px;">Max. Hydroplane Slew Rate</td>
</tr>
<tr>
  <td><input id="maxBowplaneAngleInput" value="45.0" step="0.1" min= "0" max="45" type="number" style="width:60px;text-align:right" onkeypress="return isNumberKey(event)"/></td>
  <td style="width:163px;text-align:center;font-family:'Garamond';font-size: 14px;">Max. Bowplane Angle</td>
</tr>
<tr>
  <td><input id="maxSternplaneAngleInput" value="45.0" step="0.1" min= "0" max="45" type="number" style="width:60px;text-align:right" onkeypress="return isNumberKey(event)"/></td>
  <td style="width:163px;text-align:center;font-family:'Garamond';font-size: 14px;">Max. Sternplane Angle</td>
</tr>
</tr>
  
  
</table>
<script>
  /*
b.maxplanerate = maxplanerateInput.value;
                    b.maxPitch = maxpitchInput.value;
                    b.maxBowplaneAngle = maxBowplaneAngleInput.value;
                    b.maxSternplaneAngle = maxSternplaneAngleInput.value;
                    b.UsePitchForDepthChanges = UsePitchForDepthChangesInput.value;
                    */
  </script>
  
<button id="PlaneGainsToggle" style="position:absolute;left:696px;top:81px;width:184px;height:25px;" onClick="TogglePlaneGainsTable();">Edit Diveplane Controller</button>
  
<button id="PlantPhysicsToggle" style="position:absolute;left:15px;top:41px;width:200px;height:25px;" onClick="TogglePlantPhysicsTable();">Edit Submarine Plant</button>
  
<button id="readoutThing" style="position:absolute;left:25px;top:125px;width:200px;height:25px;" onClick="">READOUT</button>
  
<button id="FreezeDepthToggle" style="position:absolute;left:15px;top:300px;width:114px;height:25px;" onClick="ToggleFreezeDepth();">Freeze Depth</button>
  

  <button id="UpdatePlantbutton" style="position:absolute;left:201.5px;top:383px;width:54px;height:19px;text-align:center;font-family:'Garamond';font-size: 14px;border: 1px solid #00508a;display:none;" value="false" onClick="">Update</button>
  
<button id="RTPDbutton" style="position:absolute;left:717px;top:300px;width:163px;height:25px;" value="false" onClick="RTPD();">Order Periscope Depth</button>
  
<button id="RTSDbutton" style="position:absolute;left:717px;top:325px;width:163px;height:25px;" value="false"  onClick="RTSD();">Order Standard Depth</button>

<button id="RTDDbutton" style="position:absolute;left:717px;top:350px;width:163px;height:25px;" value="false"  onClick="RTDD();">Order Deep Ops Depth</button>

<button id="Timerbutton" style="position:absolute;left:50px;top:150px;width:163px;height:25px;" value="false" >0</button>

<input type="checkbox" style="position:absolute;left:5px;top:90px;" id="NiceGraphicsON" checked>

  <input type="range" min="-45" max="45" step="0.01" value="0" class="slider" id="BPrange" style="position:absolute;left:600px;top:300px;width:50px;writing-mode: vertical-lr;direction: rtl;">
<input type="range" min="-45" max="45" step="0.01" value="0" class="slider" id="SPrange" style="position:absolute;left:250px;top:300px;width:50px;writing-mode: vertical-lr;direction: rtl;" disabled>


<script type="text/javascript">
'use strict';
(function(){
    
    const FrictionHalfLifeSeconds = 0.1;//1.5 //not used currently
    const SubMass = 50e3; //not used currently

    // Rendering constants
    const PixelsPerMeter = 100.0;       // rendering zoom factor
    const iOrigin = 865/2;                // hor location of world origin on canvas [pixels]
    const jOrigin = 100;                // ver location of world origin on canvas [pixels]
    const SubRadiusMeters = 0.01;
    
    const manualDBinc = 15; //deg
  
    const manualDSinc = 15; //deg
    
    var sim;

    class Sub {
        constructor(mass, anchor, x, y, xi) {
            this.mass = mass;
            this.anchor = anchor;   // 0=mobile, positive=fixed in place
            this.SF = 1/50; //length scale factor for screen
            this.L = 75*this.SF;//1.5; //boat length // length dimensions are in 50m increments
            this.h = (this.L/15); //boat halfheight (radius)
            this.dsl =(this.L/15);  // hydroplane length
            this.finH = Math.max((this.dsl+this.h)/2,this.dsl);
            // position vector
            this.x = x;
            this.y = y;
            this.xi = [0,0,0,this.L/this.SF,0];
            this.yi = [...this.xi];
            this.ui = [0,0,0,0,0];
            this.uiprev = [0,0,0,0,0];
            this.xeint = [0,0,0];
            this.uint = [0,0,0];
            this.depthDem = this.yi[3];
            this.pitchDem = 0;
            this.pitchSP = 0;
            this.freezeDepth = 0;
            
            this.maxplanerate = 15;
            this.maxPitch = 15;
            this.maxBowplaneAngle = 45;
            this.maxSternplaneAngle = 45;
            this.UsePitchForDepthChanges = true;
          
            this.Compressibility = 1;
            this.compFactor = 1e-3;
            this.TrimTarget = 'order';//'order' or 'measurement';
            this.TrimCompensator = 1;
            this.compzd = 0;
            this.trimz = this.yi[3];
            this.trimEffort = 0;
            this.trimErr = (this.compzd/this.compFactor); 
            this.txi = [0,0,0];
            this.tui = [0,0];
            this.PlantUpdatingPrev = 0;
            this.PlantUpdatingTimer = 50;
          
            this.SliderControl = false;
            this.SliderControlMaintainPitch = true;
          
            //plant matrices
            /*
            this.A = [[0,0,0,0,0,0,0],
            [0,-0.333,-9.63,0,-1.51,0,0],
            [0,0.00837,-0.507,0,0.0333,0,0],
            [0,1,0,0,0,0,0],
            [0,0,1,0,0,0,0],
            [0,0,0,1,0,0,0],
            [0,0,0,0,1,0,0],
            ];
            this.B = [[0,0,0,0,0],
            [0,-1.04,0.836,7.33e-07,-2.11e-08],
            [0,0.0301,-0.077,-1.41e-08,9.95e-10],
            [0,0,0,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
            [0,0,0,0,0],
            ];
            //*/
          ///*
          this.A = [[0,0,0,0,0,0,0],
[0,-0.0989,-0.717,0,-0.423,0,0],
[0,0.00182,-0.319,0,-0.00164,0,0],
[0,1,0,0,0,0,0],
[0,0,1,0,0,0,0],
[0,0,0,1,0,0,0],
[0,0,0,0,1,0,0],
];
          let dimp = 0.1;
this.B = [[0,0,0,0,0],
[0,-0.0131,-0.00905,1.71e-07,-2.31e-09],
[0,0.000437,-0.000396,-1.54e-09,2.99e-10],
[0,0,0,0,0],
[0,0,0,0,0],
[0,0,0,0,0],
[0,0,0,0,0],
];
          //*/
            //CARE:
            /*
            this.dbG = [0, -0.5, 13, -0.15, 2.5, -1e-03, 0.01];
            this.dsG = [0, -0.2, -120, -0.01, -42, -1e-03, -0.4];
            //*/
            //
//this.dbG = [0, -0.474, 7.01, -0.0446, 2.44, -0.000745, 0.00324];
//this.dsG = [0, -0.112, -1.61, -0.00402, -0.498, -9.57e-05, -0.0126];
//this.dbG = [0, -3.59, 69.5, -0.565, 23.8, -0.00232, 0.00444];
//this.dsG = [0, -0.954, -17.2, -0.127, -5.01, -0.000586, -0.0176];
this.dbG = [0, -5.86, 74.2, -0.668, 26.2, -0.00715, 0.00592];
this.dsG = [0, -2.36, -16.5, -0.185, -4.31, -0.00247, -0.0171];
            //*/
            ctrldb_zD.value = this.dbG[1];
            ctrldb_zP.value = this.dbG[3];
            ctrldb_zI.value = this.dbG[5];
            ctrldb_thtD.value = this.dbG[2];
            ctrldb_thtP.value = this.dbG[4];
            ctrldb_thtI.value = this.dbG[6];
            ctrlds_zD.value = this.dsG[1];
            ctrlds_zP.value = this.dsG[3];
            ctrlds_zI.value = this.dsG[5];
            ctrlds_thtD.value = this.dsG[2];
            ctrlds_thtP.value = this.dsG[4];
            ctrlds_thtI.value = this.dsG[6];
          
            this.maxTrimz = 275;
            this.minTrimz = 2.5;
            this.teint = 0;
            
            this.periodegM = 1;
            this.periodegS = 1;
            this.periodegS2 = 1;
            this.periodegC = 1;
            this.periodegInc = 5;
            this.periodegInc2 = 12;
          
            this.SeaState = 0.49;
            this.SeaFixed = 1;
            
            this.zDem = new Array(650);
            this.zDem.fill(this.depthDem*this.SF)
  
            this.AP = [0,1,1];//[0,1,1];
            this.APprev = this.AP;
          
            this.resetInt = 1;
          
            //trim compensation response
            this.tcr = new Array(500);
            this.tcr.fill(this.yi[3]*this.SF)
          
            this.zh = new Array(500);
            this.zh.fill(this.yi[3]*this.SF)
            
            this.ssFZ = new Array(1250);
            this.ssFZ.fill(0);
            this.ssAlt = new Array(1250);
            this.ssAlt.fill(0);
            this.ssMoving = new Array(1250);
            this.ssMoving.fill(0);
            this.ssMoving2 = new Array(1250);
            this.ssMoving2.fill(0);
          
            this.surfaced = false;

            // velocity vector
            this.vx = 0.0;
            this.vy = 0.0;

            // force vector
            this.fx = 0.0;
            this.fy = 0.0;
          
            this.waveHeight = 0;
            this.trailCounter = 0;
            this.trailCounterCap = -1;
            this.waveshimmer = 0;
            this.W = 0;
        }

        Distance(x, y) {
            const dx = this.x - x;
            const dy = this.y - y;
            return Math.sqrt(dx*dx + dy*dy);
        }
    }

    
                  RTSDbutton.addEventListener('click', function() { 
    //console.clear();
    console.log('RTSD clicked!');
    sim.depthOrder('SD');
}); 
                  RTPDbutton.addEventListener('click', function() { 
    //console.clear();
    //console.log('RTPD clicked!');
    sim.depthOrder('PD');
});
  RTDDbutton.addEventListener('click', function() { 
    //console.clear();
    console.log('RTDD clicked!');
    sim.depthOrder('DD');
}); 

BPrange.addEventListener('mousedown',function(){
  sim.AssumeSliderControl();
  console.log('BPrangeON');
});
BPrange.addEventListener('mouseup',function(){
  sim.ReleaseSliderControl();
  console.log('BPrangeOFF');
});
  
UpdatePlantbutton.addEventListener('click',function(){
                    
  var Ukts = 10;
  var rho = Math.abs(Plant_rho.value);//1030;
  var g = 9.81;
  var L = Math.abs(Plant_L.value); //75
  var mass = Math.abs(Plant_mass.value*1e3); //1000*1e3;
  var r = Math.abs(Plant_r.value); //5
  var zcb = Plant_zcb.value; //-1;
  
  //Hull calcs
  var zcg = 0; //fixed CG
  var BG = zcg-zcb;
  var Iy = (1/12)*mass*(3*Math.pow(r,2)+Math.pow(L,2)); //cylinder inertia
  //Hull Mass hydrodynamic terms
  var Z_Wdot = Plant_Z_Wdot.value;//-(6.0);
  var Z_Qdot = Plant_Z_Qdot.value;//-(3.0);
  var M_Wdot = Plant_M_Wdot.value;//-(2.0);
  var M_Qdot = Plant_M_Qdot.value;//-(1.0);
  //Hull Damper hydrodynamic terms
  var Z_UW =  Plant_Z_UW.value;//-(36.0);
  var Z_UQ =  Plant_Z_UQ.value;//-(12.0);
  var M_UW =  Plant_M_UW.value;//+(3.0);
  var M_UQ =  Plant_M_UQ.value;//-(12.0);
  //Hydroplane hydrodynamic terms
  var Z_UUdb = Plant_Z_UUdb.value;//-(8.0);
  var Z_UUds = Plant_Z_UUds.value;//-(10.0);
  var M_UUdb = Plant_M_UUdb.value;//+(2.0);
  var M_UUds = Plant_M_UUds.value;//-(3.0);
  var U = Ukts*0.51444;
  
  //dimensionalisation
  var rL2 = (1/1000)*0.5*rho*Math.pow(L,2);
  var rL3 = (1/1000)*0.5*rho*Math.pow(L,3);
  var rL4 = (1/1000)*0.5*rho*Math.pow(L,4);
  var rL5 = (1/1000)*0.5*rho*Math.pow(L,5);
  var Usq = Math.pow(U,2);
  
  //MSD system
  
  var MASS = [
             [mass-Z_Wdot*rL3,         -Z_Qdot*rL4],
             [-M_Wdot*rL4    ,       Iy-M_Qdot*rL5],
             ];

  var DAMPER = [
               [-Z_UW*rL2*U   , -(Z_UQ*rL3+mass)*U],
               [-M_UW*rL3*U   ,        -M_UQ*rL4*U],
               ];
 
  var SPRING = [ 
               [0,        0],
               [0,mass*g*BG],
               ];
  
  var R = [
          [Z_UUdb*rL2*Usq, Z_UUds*rL2*Usq, 1, 0],
          [M_UUdb*rL3*Usq ,M_UUds*rL3*Usq, 0, 1],
          ];

  //Matrix Construction
  var invMASS = math.inv(MASS);
  var minusInvMASS = math.multiply(-1,invMASS);
  var Afp1 = math.multiply(minusInvMASS,DAMPER);
  var Afp2 = math.multiply(minusInvMASS,SPRING);
  var Afp = math.concat(Afp1,Afp2);
  var Af = math.concat(Afp,[
      [1,0,0,-U], //account for zdot = w - sin(theta)
      [0,1,0,0],
      ],0);
  var Bf = math.concat(math.multiply(invMASS,R),[
      [0,0,0,0],
      [0,0,0,0],
      ],0);

  var T = [
      [1,0,0,-U], //account for zdot = w - sin(theta)
      [0,1,0,0],
      [0,0,1,0],
      [0,0,0,1],
      ];
  var invT = [
      [1,0,0,+U], //account for zdot = w - sin(theta)
      [0,1,0,0],
      [0,0,1,0],
      [0,0,0,1],
      ];
  
  //console.log(Af);
  //console.log(math.multiply(Af,T));
  var At = math.multiply(T,math.multiply(Af,invT));
  var Bt = math.multiply(T,Bf);

  //add integrator states:
  var iAH = [
            [0,0],
            [0,0],
            [0,0],
            [0,0],
           ];
  var iAV = [
            [0,0,1,0,0,0],
            [0,0,0,1,0,0],
           ];
  var iBV = [
             [0,0,0,0],
             [0,0,0,0],
            ];
  var An = math.concat(math.concat(At,iAH,1),iAV,0);
  var Bn = math.concat(Bt,iBV,0);
  var Atop0 = [[0,0,0,0,0,0]];
  var Aside0 = [[0],[0],[0],[0],[0],[0],[0]];
  var An0t = math.concat(Atop0,An,0);
  var An0 = math.concat(Aside0,An0t,1);
  var Btop0 = [[0,0,0,0]];
  var Bside0 = [[0],[0],[0],[0],[0],[0],[0]];
  var Bn0t = math.concat(Btop0,Bn,0);
  var Bn0 = math.concat(Bside0,Bn0t,1);
                    
                    sim.UpdatePlant(An0,Bn0,L,r)
                    
                  });

    class Simulation {
        constructor() {
            this.subList = [];
            this.springList = [];

            // Initialize gravity vector: 9.8 m/s^2, pointing straight down.
            this.gravity = -9.81;

            this.grabbedSub = null;
        }

        AddSub(sub) {
            this.subList.push(sub);
            return sub;
        }

        Update(dt) {
            var b, s;

            // Calculate the force vectors acting on all the subs:
            // both from springs and from gravity.

            // Start out with just the gravitational force on each sub.
            for (b of this.subList) {
                //b.fx = 0.0;
                //b.fy = b.mass * this.gravity;
            }

            // Go through all the springs and calculate
            // the forces on the subs connected to their endpoints.
            // There will be equal and opposite forces on each pair.
            //for (s of this.springList) {
            //    s.AddForce();
            //}

            // Now all the forces are correct.
            // Use the forces to update the position and speed of each sub.
            const friction = Math.pow(0.5, dt / FrictionHalfLifeSeconds);
            for (b of this.subList) {
                if (b.anchor === 0) {       // skip anchors, because they don't move
                    // F = ma, therefore a = dv/dt = F/m.
                    // dv = dt * F/m
                    let xdi = [];
                    var Dived = !b.surfaced;
                    
                    if (b.AP[1] != b.APprev[1]){
                      b.resetInt = 1;
                    }
                    if (b.AP[2] != b.APprev[2]){
                      b.resetInt = 1;
                    }
                    b.APprev = b.AP;
                  
                    var CompensationTarget
                    if (b.TrimTarget == 'measurement'){
                      CompensationTarget = b.yi[3];
                    }else if (b.TrimTarget == 'order'){
                      CompensationTarget = b.depthDem;
                    }
                    
                    b.compzd = b.Compressibility*b.compFactor*(b.yi[3]);
                    b.trimzd = b.Compressibility*b.compFactor*(b.trimz);
                    //trim error in m
                    b.trimErrPrev = b.trimErr;
                    b.trimErr = CompensationTarget-b.trimz;
                  
                    b.trimOffset = (b.compzd-b.trimzd)/b.compFactor;
                    
                    maxplanerateInput.value = Math.max(Math.min(45,maxplanerateInput.value),0);
                    b.maxplanerate = maxplanerateInput.value;
                    maxpitchInput.value = Math.max(Math.min(20,maxpitchInput.value),0);
                    b.maxPitch = maxpitchInput.value;
                    maxBowplaneAngleInput.value = Math.max(Math.min(45,maxBowplaneAngleInput.value),0);
                    b.maxBowplaneAngle = maxBowplaneAngleInput.value;
                    maxSternplaneAngleInput.value = Math.max(Math.min(45,maxSternplaneAngleInput.value),0);
                    b.maxSternplaneAngle = maxSternplaneAngleInput.value;
                    b.UsePitchForDepthChanges = UsePitchForDepthChangesInput.checked;
                  
                    b.SliderControlMaintainPitch = SliderControlMaintainPitchInput.checked;
                  
                    if (b.SliderControlMaintainPitch){
                      SliderControlRatioInput.disabled = true;
                    }else{
                      SliderControlRatioInput.disabled = false;
                    }
                    SliderControlRatioInput.value = Math.max(Math.min(SliderControlRatioInput.value,SliderControlRatioInput.max),SliderControlRatioInput.min);
                  
                    //zd q z tht
                    //xdi = [0,b.compzd-b.trimzd+0.0,0,0,0];
                    /*
                    for (var o = o; o<xdi.length; o++){
                      for (var state = 0; state<b.A[0].length; state++){
                        xdi[o] += b.A[o][state]*b.xi[state]; //A*x
                      }
                      for (var input = 0; input<b.B[0].length; input++){
                        xdi[o] += b.B[o][input]*b.ui[input]; //B*u
                      }
                    }
                    //*/
                    //var xdi_s = [0,0,0,0,0,0,0];
                    //var xdi_i = [0,0,0,0,0];
                  
                    
                    //var xdi_f = matrixmultiply([[0,0,0,0,0],[0,1,2,3,4],[0,5,6,7,8]],[[0],[2],[2],[2],[2]]);
                    /*
                    function matrixmultiply(m1, m2) {
                        var result = [];
                        for (var i = 0; i < m1.length; i++) {
                            result[i] = [];
                            for (var j = 0; j < m2[0].length; j++) {
                                var sum = 0;
                                for (var k = 0; k < m1[0].length; k++) {
                                    sum += m1[i][k] * m2[k][j];
                                }
                                result[i][j] = sum;
                            }
                        }
                        return result;
                    };
                    var xi_s = [
                                [b.xi[0]],
                                [b.xi[1]],
                                [b.xi[2]],
                                [b.xi[3]],
                                [b.xi[4]],
                                [b.xi[5]],
                                ];
                    //console.log(xi_s)
                    var xi_u = [
                                [b.ui[0]],
                                [b.ui[1]],
                                [b.ui[2]],
                                [b.ui[3]],
                                [b.ui[4]],
                                [b.ui[5]],
                                ];
                    var xdi_s = matrixmultiply(b.A,xi_s);
                    var xdi_u = matrixmultiply(b.B,xi_u);
                    xdi = xdi_s+xdi_u;
                    readoutThing.innerHTML = (b.A[2][2]);
                    //*/
                    
                    //readoutThing.innerHTML = b.surfaced;//b.yi[3].toFixed(15);
                    //b.yi[3]=b.yi[3]*50;0
                    
                    xdi[0] = 0;
                    xdi[1] = (b.A[1][1])*b.xi[1]+(b.A[1][2])*b.xi[2]+(b.A[1][4])*b.xi[4]+ 1*(b.compzd-b.trimzd) + (b.B[1][1])*Dived*b.ui[1]+(b.B[1][2])*Dived*b.ui[2]+(b.B[1][3])*b.ui[3]+(b.B[1][4])*b.ui[4];
                    xdi[2] = (b.A[2][1])*b.xi[1]+(b.A[2][2])*b.xi[2]+(b.A[2][4])*b.xi[4]  + (b.B[2][1])*Dived*b.ui[1]+(b.B[2][2])*Dived*b.ui[2]+(b.B[2][3])*b.ui[3]+(b.B[2][4])*b.ui[4];
                    xdi[3] = (1)*b.xi[1];
                    xdi[4] = (1)*b.xi[2];
                    //*/
                    /*
                    xdi[0] = 0;
                    xdi[1] = (-0.0584)*b.xi[1]+(-3.0671)*b.xi[2]+(-0.2633)*b.xi[4]+ b.compzd-b.trimzd + (0.0092)*Dived*b.ui[1]+(-0.337)*Dived*b.ui[2]+(1.001e-05)*b.ui[3]+(-1.18e-07)*b.ui[4];
                    xdi[2] = (0.0051)*b.xi[1]+(-0.3767)*b.xi[2]+(0.0114)*b.xi[4]  + (0.0736)*Dived*b.ui[1]+(-0.0698)*Dived*b.ui[2]+(-1.18e-07)*b.ui[3]+(5.767e-08)*b.ui[4];
                    xdi[3] = (1)*b.xi[1];
                    xdi[4] = (1)*b.xi[2];
                    */
                    
                    
                  for (var f = 0; f< b.xi.length; f++){
                    b.xi[f] += dt*xdi[f];
                  }
                  
                  //hard limit on pitch.
                  
                  if (b.xi[4] > 60*Math.PI/180){
                    b.xi[4] = 60*Math.PI/180;
                  }else if(b.xi[4]<-60*Math.PI/180){
                    b.xi[4] = -60*Math.PI/180;
                  }
                  //console.log(b.xi[3])
                  var tailz = b.xi[3]+0.5*(b.L/b.SF)*Math.sin(-b.xi[4]);
                  var nosez = b.xi[3]-0.5*(b.L/b.SF)*Math.sin(b.xi[4]);
                  
                  // surfaced dynamics
                  if (b.xi[3] < 0.5 || tailz < -5 || nosez < -5){
                    //if (b.surfaced == false){
                      //b.ui[4] = b.ui[4]-9.81*1e4;
                      if (b.surfaced == false){
                        b.xi[1] = b.xi[1]*0.5;
                        b.xi[2] = b.xi[2]-b.xi[4]*0.5;
                        b.ui[3] = b.ui[3]+500*9.81*1e3+(Math.abs(b.xi[4])*1e3);
                        b.ui[4] = b.ui[4]-Math.sign(b.xi[4])*250*9.81*1e4;
                      }
                      b.ui[3] = b.ui[3]+250*9.81*1e3;
                      b.ui[4] = b.ui[4]-Math.sign(b.xi[4])*10*9.81*1e4;
                      b.surfaced = true;
                    //}
                  }else{
                      if (b.surfaced == true){
                        //b.xi[1] = b.xi[1]*0.3;
                        b.ui[3] = -0.5*b.ui[3];
                        b.ui[4] = -0.5*b.ui[4];
                      }
                      b.surfaced = false;
                  }
                  //*/
                  // C matrix application
                  b.yi = [...b.xi]
                  b.yi[0] = b.yi[0];
                  b.yi[1] = b.yi[1];
                  b.yi[2] = b.yi[2]*180/Math.PI;
                  b.yi[3] = b.yi[3];
                  b.yi[4] = b.yi[4]*180/Math.PI;
                  
                  
                  
                  let txdi = [];
                  txdi[0] = 0;
                  txdi[1] = (-2.8886)*b.txi[1]+(-1)*b.txi[2]+b.tui[1]; //-2.8886
                  txdi[2] = b.txi[1];
                  for (var f = 0; f< b.txi.length; f++){
                    b.txi[f] += dt*txdi[f];
                  }
                  b.trimz = Math.max(b.minTrimz,Math.min(b.maxTrimz,b.trimz+b.txi[1]));//b.trimEffort*dt;
                  
                  
                  var zhdummy;
                  for (var f = 0; f< b.zh.length-1; f++){
                    zhdummy = b.zh[f+1];
                    b.zh[f] = zhdummy;
                  }
                  b.zh[b.zh.length-1] = b.yi[3]*b.SF+(0.5+15/100)*b.L*Math.sin(b.yi[4]*Math.PI/180);
                  //console.log(b.zh.length)
                  
                  var zDemdummy;
                  for (var f = 0; f< b.zDem.length-1; f++){
                    zDemdummy = b.zDem[f+1];
                    b.zDem[f] = zDemdummy;
                  }
                  b.zDem[b.zDem.length-1] = b.depthDem*b.SF;
                  
                  var tcrdummy;
                  for (var f = 0; f< b.tcr.length-1; f++){
                    tcrdummy = b.tcr[f+1];
                    b.tcr[f] = tcrdummy;
                  }
                  b.tcr[b.tcr.length-1] = b.trimz*b.SF;
                  
                  
                  
                  //let depthDem = 3; //b.yi[3]
                  
                  let zErr = (b.depthDem-(b.yi[3]+b.waveHeight)); // depth error + wave height sensor noise
                  
                  //let zdErr = 0.2*5*0.8*(zErr)*Math.PI/180-b.yi[1];
                  
                  var zdErr = 0;
                  var qErr = 0;
                  var thtErr = 0;
                  
                  
                  let maxPitch = b.maxPitch;
                  var useZdErr;
                  
                  if (b.AP[1] == 1 && b.AP[2] == 1){
                  if (Math.abs(zErr)>[b.h*5/b.SF] && maxPitch != 0 && b.UsePitchForDepthChanges && !b.SliderControl){
                      b.pitchDem = -Math.sign(zErr)*maxPitch;//Math.min(Math.max(-maxPitch*0.8*(zErr/30)*Math.PI/180,-maxPitch*Math.PI/180),maxPitch*Math.PI/180);
                      zdErr = -10*0.51444*Math.sin(b.pitchDem*Math.PI/180)-b.yi[1];
                      qErr = 0*dt*b.pitchDem-b.yi[2];
                      thtErr = b.pitchDem-b.yi[4];
                      useZdErr = true;
                  }else{
                      b.pitchDem = b.pitchSP;
                      zdErr = 5*(zErr)*Math.PI/180-b.yi[1];
                      qErr = 0-b.yi[2];
                      thtErr = b.pitchDem-b.yi[4];
                      useZdErr = false;
                  }
                  }
                  if (b.pitchDem < -maxPitch){
                    b.pitchDem = -maxPitch;
                  }
                  if (b.pitchSP > maxPitch){
                    b.pitchSP = maxPitch;
                  }
                  if (b.pitchSP < -maxPitch){
                    b.pitchSP = -maxPitch;
                  }
                  
                  //readoutThing.innerHTML = zErr;
                  
                  //let qErr = 0.05*b.pitchDem-b.yi[2];
                  //let thtErr = b.pitchDem-b.yi[4];
                  
                  //db
                  /*
                  //*/
                  //
                  var Gdb_zP
                  if (ctrldb_zP.value!==""){
                    Gdb_zP=ctrldb_zP.value;
                  }else{
                    Gdb_zP=0;
                  }
                  var Gdb_zI
                  if (ctrldb_zI.value!==""){
                    Gdb_zI=ctrldb_zI.value;
                  }else{
                    Gdb_zI=0;
                  }
                  var Gdb_zD
                  if (ctrldb_zD.value!==""){
                    Gdb_zD=ctrldb_zD.value;
                  }else{
                    Gdb_zD=0;
                  }
                  var Gdb_thtP
                  if (ctrldb_thtP.value!==""){
                    Gdb_thtP=ctrldb_thtP.value;
                  }else{
                    Gdb_thtP=0;
                  }
                  var Gdb_thtI
                  if (ctrldb_thtI.value!==""){
                    Gdb_thtI=ctrldb_thtI.value;
                  }else{
                    Gdb_thtI=0;
                  }
                  var Gdb_thtD
                  if (ctrldb_thtD.value!==""){
                    Gdb_thtD=ctrldb_thtD.value;
                  }else{
                    Gdb_thtD=0;
                  }
                  //ds
                  /*
                  //*/
                  //
                  var Gds_zP
                  if (ctrlds_zP.value!==""){
                    Gds_zP=ctrlds_zP.value;
                  }else{
                    Gds_zP=0;
                  }
                  var Gds_zI
                  if (ctrlds_zI.value!==""){
                    Gds_zI=ctrlds_zI.value;
                  }else{
                    Gds_zI=0;
                  }
                  var Gds_zD
                  if (ctrlds_zD.value!==""){
                    Gds_zD=ctrlds_zD.value;
                  }else{
                    Gds_zD=0;
                  }
                  var Gds_thtP
                  if (ctrlds_thtP.value!==""){
                    Gds_thtP=ctrlds_thtP.value;
                  }else{
                    Gds_thtP=0;
                  }
                  var Gds_thtI
                  if (ctrlds_thtI.value!==""){
                    Gds_thtI=ctrlds_thtI.value;
                  }else{
                    Gds_thtI=0;
                  }
                  var Gds_thtD
                  if (ctrlds_thtD.value!==""){
                    Gds_thtD=ctrlds_thtD.value;
                  }else{
                    Gds_thtD=0;
                  }
                  //console.log(Number(Gdb_z))
                  
                  let dbG = [0, Gdb_zD,    Gdb_thtD,      Gdb_zP,    Gdb_thtP,  Gdb_zI, Gdb_thtI];
                  let dsG = [0, Gds_zD,    Gds_thtD,      Gds_zP,    Gds_thtP,  Gds_zI, Gds_thtI];
                  
                  
                  if (b.PlantUpdatingTimer >0){
                    b.PlantUpdatingTimer = b.PlantUpdatingTimer - 1;
                    var puTimer = Math.abs(b.PlantUpdatingTimer/50);
                    UpdatePlantbutton.style.backgroundColor = "rgba("+255+","+(1-puTimer)*255+","+(1-puTimer)*255+",1)";
                  }else{
                    b.PlantUpdatingTimer = 0;
                    UpdatePlantbutton.style.backgroundColor = "rgba(200,255,200,1)";
                  };
                  //UpdatePlantbutton.innerHTML = b.PlantUpdatingTimer;
                  
                  
                  if (b.resetInt == 1){
                    b.xeint[1] = 0;
                    b.xeint[2] = 0;
                    b.uint[1] = 0;
                    b.uint[2] = 0;
                    b.teint = 0;
                    b.resetInt = 0;
                  }else{
                    if (b.SliderControl == true){
                      //(FreezeIntegrators)
                      b.uint[1] += 0;
                      b.uint[2] += 0;
                      //b.xeint[1] += 0;
                      //b.xeint[2] += 0;
                    }else{
                      b.uint[1] += 0;
                      b.uint[2] += 0;
                      //b.xeint[1] += 0;zdErr*dt; //obsolete
                      //b.xeint[2] += 0;thtErr*dt; //obsolete
                    }
                    b.teint += b.trimErr*dt;
                  }
                  
                  let tkP = 0.9*1e-4;
                  let tkI = 0.0*1e-4;
                  let tkD = 1.5*1e-4;
                  let trimEffortSat = 0.05;//1e6*0.1;
                  if (b.TrimCompensator){
                      b.trimEffort = b.trimErr*tkP+b.teint*tkI*dt+(b.trimErr-b.trimErrPrev)*tkD/dt;
                      if (b.trimEffort > trimEffortSat){
                        b.trimEffort = trimEffortSat;
                        //b.teint = b.teint-b.trimErr*dt;
                      }else if (b.trimEffort < -trimEffortSat){
                        b.trimEffort = -trimEffortSat;
                        //b.teint = b.teint-b.trimErr*dt;
                      }
                      b.tui[1] = b.tui[1]+b.trimEffort;
                      var maxtui = 50;
                      b.tui[1] = Math.min(maxtui,Math.max(-maxtui,b.tui[1]));
                  }
                  
                  // integrators:
                  var intZErr;
                  if (useZdErr == true){
                      intZErr = zdErr;
                  }else{
                      intZErr = zErr;
                  }
                  var BPintZeroMod
                  var SPintZeroMod
                  if (b.SliderControl){
                    BPintZeroMod = 0;
                    if (b.SliderControlMaintainPitch){
                      SPintZeroMod = 1;
                    }else{
                      SPintZeroMod = 0;
                    }
                  }else{
                    BPintZeroMod = 1;
                    SPintZeroMod = 1;
                  }
                  if (b.AP[1] == 1){
                  b.uint[1] = Math.max(Math.min(b.uint[1]+BPintZeroMod*dbG[5]*intZErr*dt+BPintZeroMod*dbG[6]*thtErr*dt,b.maxBowplaneAngle),-b.maxBowplaneAngle);
                  }
                  if (b.AP[2] == 1){
                    b.uint[2] = Math.max(Math.min(b.uint[2]+SPintZeroMod*dsG[5]*intZErr*dt+SPintZeroMod*dsG[6]*thtErr*dt,b.maxSternplaneAngle),-b.maxSternplaneAngle);
                  }
                  
                  if (b.AP[1] == 1){
                    b.uiprev[1] = b.ui[1];
                    b.ui[1] = zdErr*dbG[1]+qErr*dbG[2]+zErr*dbG[3]+thtErr*dbG[4];
                    if (b.SliderControl){
                      b.ui[1] = Math.min(Math.max(BPrange.value,-b.maxBowplaneAngle),+b.maxBowplaneAngle);
                    }else{
                      b.ui[1] += b.uint[1];
                    }
                    
                    if (Math.abs(b.ui[1]-b.uiprev[1])>b.maxplanerate*dt){
                      b.ui[1] = b.uiprev[1]+Math.sign(b.ui[1]-b.uiprev[1])*b.maxplanerate*dt;
                    }
                  }
                  
                  if (b.AP[2] == 1){
                    b.uiprev[2] = b.ui[2];
                    b.ui[2] = zdErr*dsG[1]+qErr*dsG[2]+zErr*dsG[3]+thtErr*dsG[4];
                    if (b.SliderControl && !b.SliderControlMaintainPitch){
                      b.ui[2] = Math.min(Math.max((SliderControlRatioInput.value)*BPrange.value,-b.maxSternplaneAngle),+b.maxSternplaneAngle);
                    }else{
                      b.ui[2] += b.uint[2];
                    }
                    
                    if (Math.abs(b.ui[2]-b.uiprev[2])>b.maxplanerate*dt){
                      b.ui[2] = b.uiprev[2]+Math.sign(b.ui[2]-b.uiprev[2])*b.maxplanerate*dt;
                    }
                  }
              
                  if (Math.abs(b.ui[1]) >= b.maxBowplaneAngle){
                    b.ui[1] =  Math.sign(b.ui[1])*b.maxBowplaneAngle;
                  }
                  if (Math.abs(b.ui[2]) >= b.maxSternplaneAngle){
                    b.ui[2] =  Math.sign(b.ui[2])*b.maxSternplaneAngle;
                  }
                  
                  if (!b.SliderControl){
                    BPrange.value = b.ui[1];
                  }
                  SPrange.value = b.ui[2];
                  
                  
                  //Sea Forces
                  
                  var SeaState
                  if (b.SeaFixed == 0){
                    b.SeaState = b.SeaState+0.1*(Math.random()-0.5)
                    if (b.SeaState < 0){
                      b.SeaState = 0;
                    }else if (b.SeaState > 9){
                      b.SeaState = 9;
                    }
                  }
                  
                  b.SeaForcePerScreenUnit = 0.25*1e3*9.81;
                  let ssFZmag = b.SeaForcePerScreenUnit*b.SeaState; // Newtons per FM trail array element (each approx 2.48m in length)
                  
                  
                  var periodegInc
                  periodegInc = b.periodegInc+2*(Math.random()-0.5)/1;
                  if (periodegInc > 20){
                      periodegInc = 20;
                  }else if (periodegInc < 0.5){
                    periodegInc = 0.5;
                  }
                  b.periodegInc = periodegInc;
                  
                  var periodegInc2
                  periodegInc2 = b.periodegInc2+2*(Math.random()-0.5)/1;
                  if (periodegInc2 > 15){
                      periodegInc2 = 15;
                  }else if (periodegInc2 < 2){
                    periodegInc2 = 2;
                  }
                  b.periodegInc = periodegInc;
                  
                  var periodegS
                  periodegS = b.periodegS+periodegInc+(Math.random()-0.5)/1000;
                  if (periodegS >= 1e4+periodegInc){
                      periodegS = periodegInc;
                  }
                  b.periodegS = periodegS;
                  
                  var periodegS2
                  periodegS2 = b.periodegS2+periodegInc2+(Math.random()-0.5)/1000;
                  if (periodegS2 >= 1e4+periodegInc2){
                      periodegS2 = periodegInc2;
                  }
                  b.periodegS2 = periodegS2;
                  
                  var periodegC
                  periodegC = b.periodegC+periodegInc+(Math.random()-0.5)/1000;
                  if (periodegC >= 1e4+periodegInc){
                      periodegC = periodegInc;
                  }
                  b.periodegC = periodegC;
                  
                  var ssFZdummy;
                  var ssFZB;
                  var sharpness_factor = 0.02;
                  if (b.trailCounter > b.trailCounterCap){
                  for (var f = 0; f< b.ssFZ.length-1; f++){
                    ssFZdummy = b.ssFZ[f+1];
                    b.ssFZ[f] = ssFZdummy;
                  }
                  }
                  ssFZB = 2.5*ssFZmag*(0.3*Math.sin(0.3*b.periodegS*Math.PI/180)+0.2*Math.sin(0.3*(57+b.periodegS2)*Math.PI/180)+0.5*Math.cos(0.3*(12+b.periodegC)*Math.PI/180));
                  
                  if (ssFZB < 0){
                    ssFZB = 0.9*-Math.pow(ssFZB,1);
                  }else{
                    ssFZB = 1*ssFZB;
                  }
                  //*/
                  b.ssFZ[b.ssFZ.length-1] = ssFZB-ssFZmag;
                  
                  let ssAltmag = ssFZmag;
                  var ssAltB;
                  var ssAltdummy;
                  if (b.trailCounter > b.trailCounterCap){
                  for (var f = 0; f< b.ssAlt.length-1; f++){
                    ssAltdummy = b.ssAlt[f+1];
                    b.ssAlt[f] = ssAltdummy;
                  }
                  }
                  ssAltB = 2.0*ssAltmag*(0.3*Math.sin((180+0.3*b.periodegS)*Math.PI/180)+0.2*Math.sin(0.3*(180+57+b.periodegS2)*Math.PI/180)+0.5*Math.cos(0.3*(180+12+b.periodegC)*Math.PI/180));
                  
                  if (ssAltB < 0){
                    ssAltB = 0.9*-Math.pow(ssAltB,1);
                  }else{
                    ssAltB = 1*ssAltB;
                  }
                  //*/
                  b.ssAlt[b.ssAlt.length-1] = ssAltB-ssAltmag;
                  
                  
                  var waveswitch
                  var waveswitch2
                  var wavelength
                  b.W = b.W+1;
                  if (b.W>=(360*50)){
                    b.W = 0;
                  }
                  readoutThing.innerHTML = b.W.toFixed(3);
                  for (var ws = 0; ws< ((b.ssMoving).length-1); ws++){
                  waveswitch = 0.5+0.5*Math.sin((5.5*ws+1.5*b.W)*Math.PI/180);
                  waveswitch2 = 0.5+0.5*Math.sin((20+6.4*ws+1.3*b.W)*Math.PI/180);
                    b.ssMoving[ws] = ((waveswitch)*b.ssFZ[ws]+(1-waveswitch)*b.ssAlt[ws]);
                    b.ssMoving2[ws] = ((waveswitch2)*b.ssAlt[ws]+(1-waveswitch2)*b.ssFZ[ws]);
                  };
                  //*/
                  
                  let seaDist = Math.max(Math.min((Math.pow(b.yi[3]/20,-1.2)-0.1),1),0);
                  
                  b.waveHeight = seaDist*(-1)*b.ssMoving[b.ssMoving.length/2]/((2/b.SF)*b.SeaForcePerScreenUnit)/b.SF;
                  
                  // new attempt (summed force and moment across boat):
                  var vehicleSpan = 124*b.L;//FMdatapoints covering length of boat in screensize
                  let trailUnitsToMetres = (vehicleSpan/(b.L/b.SF));
                      
                  b.ui[3] = (seaDist)*(b.ssMoving.slice(750-0.5*vehicleSpan/2, 750+0.5*vehicleSpan/2)).reduce((partialSum, a) => partialSum + a, 0);
                  
                  var cgx = 0.33; //relative to centre of boat
                  var momentChunksAft = (b.ssMoving.slice(750-0.5*vehicleSpan/2, 750+cgx*vehicleSpan/2));
                  var momentChunksFwd = (b.ssMoving.slice(750+cgx*vehicleSpan/2,750+0.8*vehicleSpan/2));
                  
                  for (var im = 0; im < momentChunksAft.length; im++){
                    momentChunksAft[im] = -1*momentChunksAft[im]*(momentChunksAft.length-im)*trailUnitsToMetres;
                  }
                  for (var im = 0; im < momentChunksFwd.length; im++){
                    momentChunksFwd[im] = +1*momentChunksFwd[im]*(im)*trailUnitsToMetres;
                  }
                  
                  var allMomentChunks = momentChunksAft.concat(momentChunksFwd);
                  
                  
                  b.ui[4] = (seaDist)*allMomentChunks.reduce((partialSum, a) => partialSum + a, 0);
                  //readoutThing.innerHTML = [b.ui[3].toFixed(3),b.ui[4].toFixed(3)];
                  
                  
                 //sea wave height noise on depth sensor
                 
                  
                  
                    if (FreezeDepthToggle.innerHTML == 'Unfreeze Depth'){
                      b.xi[1] = 0;
                      b.xi[3] = b.xi[3];
                    }
                  
                  if (b.trailCounter > b.trailCounterCap){
                    b.trailCounter = 0;
                  }else{
                    b.trailCounter += 1;
                  };
//*/
                }
            }
        }
      
        depthOrder(z){
          var b;
          for (b of this.subList) {
            if (typeof z === 'string'){
              function round5(x)
{
    return Math.ceil(x / 5) * 5;
};
              
              switch(z) {
                case "PD":
                  console.log(z)
                  b.depthDem = Math.ceil(2.5+(b.h+b.dsl)/b.SF);
                  break;
                case "SD":
                  b.depthDem = round5(b.L/b.SF);
                break;
                case "DD":
                  b.depthDem = round5(250);
                  // code block
                break;
              }
            }else{
              if (z < Math.ceil(0.6*b.h/b.SF)){
                b.depthDem = Math.ceil(0.6*b.h/b.SF);
              }else{
                b.depthDem = z;
              }
            }
          }
          time = 0;
        }
        
        AssumeSliderControl(){
          var b;
          for (b of this.subList) {
            b.SliderControl = true;
          };
        }
      
        ReleaseSliderControl(){
          var b;
          for (b of this.subList) {
            b.SliderControl = false;
          };
        }
        
        APall(){
          var b;
          for (b of this.subList) {
            if (b.AP[1] == 0 || b.AP[2] == 0){
              b.AP = [0,1,1];
            }else{
              b.AP = [0,0,0];
            }
            //console.log(b.zh)
          }
        }
        incDB(){
          var b;
          for (b of this.subList) {
            b.AP[1] = 0;
            b.ui[1] += manualDBinc;
                  if (Math.abs(b.ui[1]) >= b.maxBowplaneAngle){
                    b.ui[1] =  Math.sign(b.ui[1])*b.maxBowplaneAngle;
                  }
          }
        }
        
        decDB(){
          var b;
          for (b of this.subList) {
            b.AP[1] = 0;
            b.ui[1] -= manualDBinc;
                  if (Math.abs(b.ui[1]) >= b.maxBowplaneAngle){
                    b.ui[1] =  Math.sign(b.ui[1])*b.maxBowplaneAngle;
                  }
          }
        }
        
        incDS(){
          var b;
          for (b of this.subList) {
            b.AP[2] = 0;
            b.ui[2] += manualDSinc;
                  if (Math.abs(b.ui[2]) >= b.maxSternplaneAngle){
                    b.ui[2] =  Math.sign(b.ui[2])*b.maxSternplaneAngle;
                  }
          }
        }
        
        decDS(){
          var b;
          for (b of this.subList) {
            b.AP[2] = 0;
            b.ui[2] -= manualDSinc;
                  if (Math.abs(b.ui[2]) >= b.maxSternplaneAngle){
                    b.ui[2] =  Math.sign(b.ui[2])*b.maxSternplaneAngle;
                  }
          }
        }
        intReset(){
          var b;
          for (b of this.subList) {
            if (b.resetInt == 1){
              b.resetInt = 0;
            }else{
              b.resetInt = 1;
            }
          }
        }
        pitchSP_up(){
          var b;
          for (b of this.subList) {
            b.pitchSP += 2;
          }
        }
        pitchSP_down(){
          var b;
          for (b of this.subList) {
            b.pitchSP -= 2;
          }
        }
        pitchSP_level(){
          var b;
          for (b of this.subList) {
            b.pitchSP = 0;
          }
        }
        toggleCompressibility(){
          var b;
          for (b of this.subList) {
            if (b.Compressibility == 1){
              b.Compressibility = 0;
            }else{
              b.Compressibility = 1;
            }
          }
        }
        toggleTrimCompensator(){
          var b;
          for (b of this.subList) {
            if (b.TrimCompensator == 1){
              b.TrimCompensator = 0;
            }else{
              b.TrimCompensator = 1;
            }
          }
        }
        toggleTrimTarget(){
          var b;
          for (b of this.subList) {
            if (b.TrimTarget == 'measurement'){
              b.TrimTarget = 'order';
            }else{
              b.TrimTarget = 'measurement';
            }
          }
        }
        ResetStates(){
          var b;
          for (b of this.subList) {
            function round5(x)
{
    return Math.ceil(x / 5) * 5;
};
            b.xi = [0,0,0,round5(b.L/b.SF),0];
            b.yi = [...b.xi];
            b.uint = [0,0,0];
            b.ui = [0,0,0];
            b.uprev = [0,0,0];
            b.SeaState = 0;
            b.SeaFixed = true;
            b.depthDem = b.yi[3];
            b.zh.fill(b.yi[3]*b.SF)
            b.zDem.fill(b.yi[3]*b.SF)
            b.AP[1] = 0;
            b.AP[2] = 0;
            b.surfaced = false;
            b.Compressibility = 0;
            b.TrimCompensator = 1;
            b.TrimTarget = 'order';
            b.trimz = b.yi[3];
            b.trimErrPrev = 0;
            b.trimErr = 0;
            b.tcr.fill(b.yi[3]*b.SF)
            b.txi[1] = 0;
            b.txi[2] = 0;
            b.tui[1] = 0;
            b.ssFZ.fill(0);
            b.ssAlt.fill(0);
            b.ssMoving.fill(0);
            b.ssMoving2.fill(0);
            //b.ssMY.fill(0);
            b.xi = [0,0,0,round5(b.L/b.SF),0];
          }
          
        }
      UpdatePlant(A,B,L,r){
          var b;
          for (b of this.subList) {
            console.clear()
            if (b.PlantUpdatingTimer <= 0){
              b.A = A;
              b.B = B;
              b.L = L*b.SF;
              b.h = r*b.SF;
              b.dsl = Math.max(Math.min(((L+r)/16),25),2.5)*b.SF;
              b.finH = Math.max((b.dsl+b.h)/2,b.dsl);
              b.PlantUpdatingTimer = 50;
              //console.log('Update');
            }else{
              //console.log('NO_Update');
            }
          }
        }
        SeaToggle(){
          var b;
          for (b of this.subList) {
            b.SeaFixed = !b.SeaFixed;
            console.log(b.SeaFixed)
          }
        }
        SeaSelect(ss){
          var b;
          for (b of this.subList) {
            b.SeaState = (ss-48);
          }
        }

    }
    
    
    function MakeString(sim, x) {
        let anchor1 = sim.AddSub(new Sub(SubMass, 1, x, 0.0));
        let prevSub = anchor1;
        for (let i=1; i <= 1; ++i) {
            let sub = sim.AddSub(new Sub(SubMass, 0, x + (0.027 * i), -0.05 * i));
            //sim.AddSpring(new Spring(sub, prevSub, SpringRestLength, SpringConst));
            prevSub = sub;
        }
    }

    function InitWorld() {
        let sim = new Simulation();
        MakeString(sim, 0.0);
        return sim;
    }

    function ScreenHor(x) {
        return iOrigin + (PixelsPerMeter * x);
    }

    function ScreenVer(y) {
        return jOrigin + (PixelsPerMeter * y); //-
    }

    function WorldX(hor) {
        return (hor - iOrigin) / PixelsPerMeter;
    }

    function WorldY(ver) {
        return (jOrigin - ver) / PixelsPerMeter;
    }

    function Render(sim) {
        const canvas = document.getElementById('SimCanvas');
        const blurredcanvas = document.getElementById('BlurredSimCanvas');
        const context = canvas.getContext('2d');
        const bgcontext = blurredcanvas.getContext('2d');
      if (NiceGraphicsON.checked == true){
        BlurredSimCanvas.style.webkitFilter = 'blur(5px)';
        };
        // Set display size (css pixels).
        var xsize = 865;
        var ysize = 1200;
        canvas.style.outline = "1px solid #00508a";
        canvas.style.width = xsize + "px";
        canvas.style.height = ysize + "px";
        blurredcanvas.style.width = xsize + "px";
        blurredcanvas.style.height = ysize + "px";
        blurredcanvas.style.position = canvas.style.position;
        blurredcanvas.style.top = canvas.style.top;
        blurredcanvas.style.left = canvas.style.left;

        // Set actual size in memory (scaled to account for extra pixel density).
        var scale = 2;//window.devicePixelRatio; // Change to 1 on retina screens to see blurry canvas.
        canvas.width = Math.floor(xsize * scale);
        canvas.height = Math.floor(ysize * scale);
        blurredcanvas.width = Math.floor(xsize * scale);
        blurredcanvas.height = Math.floor(ysize * scale);
      

        // Normalize coordinate system to use css pixels.
        context.scale(scale, scale);
      
        context.clearRect(0, 0, canvas.clientWidth, canvas.clientHeight);
      
        bgcontext.scale(scale, scale);
      
        bgcontext.clearRect(0, 0, blurredcanvas.clientWidth, blurredcanvas.clientHeight);

        context.strokeStyle = '#03f';
        context.lineWidth = 1;

        context.strokeStyle = '#000';
        context.lineWidth = 1;
        const pixelRadius = SubRadiusMeters * PixelsPerMeter;
        for (let b of sim.subList) {
            b.xp = [...b.yi];
            b.xp[1] = b.yi[1]*b.SF;
            b.xp[2] = b.yi[2]*Math.PI/180;
            b.xp[3] = b.yi[3]*b.SF;
            b.xp[4] = b.yi[4]*Math.PI/180;
            if (b.anchor === 0) {
                //sea background
                context.lineWidth = 1;
                context.beginPath();
                context.moveTo(ScreenHor(-5),ScreenVer(0));
                context.lineTo(ScreenHor(4.5),ScreenVer(0));
                context.lineTo(ScreenHor(4.5),ScreenVer(8));
                context.lineTo(ScreenHor(-4.5),ScreenVer(8));
                context.strokeStyle = '#129aca';
              //context.stroke(); //uncomment if want to show border around sea background
                const grd = context.createLinearGradient(ScreenHor(-4.5), ScreenVer(-0.2), ScreenHor(-4.5), ScreenVer(8));
              if (b.Compressibility == 1){
grd.addColorStop(0.01, "rgba(255,255,255,0.0)");
grd.addColorStop(0.06, "rgba(0,150,140,0.1)");
grd.addColorStop(0.1, "rgba(20,150,200,0.2)");
grd.addColorStop(0.4, "rgba(20,150,200,0.4)");
grd.addColorStop(0.7, "rgba(20,150,200,0.8)");
grd.addColorStop(1.0, "rgba(0,50,170,0.8)");
              }else{
grd.addColorStop(0.01, "rgba(255,255,255,0.0)");
grd.addColorStop(0.06, "rgba(0,150,170,0.1)");
grd.addColorStop(1.0, "rgba(0,150,170,0.1)");
              }
                context.fillStyle = grd; //'rgba(20,150,200,0.1)';
                context.fill();
              
                //DepthDem
                context.setLineDash([5, 5]);
                if (b.AP[1] + b.AP[2] == 2){
                context.strokeStyle = "rgba(0,150,0,1)";
                }else if (b.AP[1] + b.AP[2] == 1) {
                context.strokeStyle = "rgba(255,150,0,1)";
                }else if (b.AP[1] + b.AP[2] == 0) {
                context.strokeStyle = "rgba(255,150,0,0)";
                }
                context.lineWidth = 1;
                context.beginPath();
                context.moveTo(ScreenHor(-4.5),ScreenVer(b.zDem[0]));
                for (let i=0; i <= (b.zDem).length; i++) {
                  context.lineTo(ScreenHor(-4.5+(4.5+0.5*b.L+0.25)*i/b.zDem.length),ScreenVer(b.zDem[i]));
                  //context.lineTo(ScreenHor(-4.5+3.5*b.L*i/b.zDem.length),ScreenVer(b.zDem[i]));
                }
                context.lineTo(ScreenHor(4.6),ScreenVer(b.depthDem*b.SF));
                context.stroke();
                context.setLineDash([]);
              
               //TrimLine / trail
                context.lineWidth = 1;
                context.beginPath();
                context.moveTo(ScreenHor(-4.5),ScreenVer(b.zh[0]));
                for (let i=1; i <= (b.tcr).length; i++) {
                  context.lineTo(ScreenHor(-4.5+(4.5-0.5*b.L-0.25)*i/b.tcr.length),ScreenVer(b.tcr[i]));
                }
                context.strokeStyle = '#ff9aca';//'#a7a7a7';
                context.stroke();
              
                //TrackLine / trail
                
                context.lineWidth = 1;
                context.beginPath();
                context.moveTo(ScreenHor(-4.5),ScreenVer(b.zh[0]));
                for (let i=1; i <= (b.zh).length; i++) {
                  context.lineTo(ScreenHor(-4.5+(4.5-0.5*b.L-0.25)*i/b.zh.length),ScreenVer(b.zh[i]));
                  //context.lineTo(ScreenHor(-4.5+2*b.L*i/b.zh.length),ScreenVer(b.zh[i]));
                }
                context.strokeStyle = '#119aca';//'#a7a7a7';
                context.stroke();
              
                context.lineWidth = 1;
                context.beginPath();
                context.setLineDash([2, 2]);
                context.moveTo(ScreenHor(b.x),ScreenVer(b.xp[3]))
                context.lineTo(ScreenHor(b.x+0.85*b.L),ScreenVer(b.xp[3]))
                context.strokeStyle = '#a7a7a7';
                context.stroke();
                context.setLineDash([]);
                context.beginPath();
                context.moveTo(ScreenHor(b.x),ScreenVer(b.xp[3]))
                context.lineTo(ScreenHor(b.x+0.8*b.L*Math.cos(b.pitchSP*Math.PI/180)),ScreenVer(b.xp[3]-0.8*b.L*Math.sin(b.pitchSP*Math.PI/180)))
                context.strokeStyle = '#a7a7a7';
                context.stroke();
                context.beginPath();
                context.moveTo(ScreenHor(b.x),ScreenVer(b.xp[3]))
                context.lineTo(ScreenHor(b.x+0.77*b.L*Math.cos(b.pitchDem*Math.PI/180)),ScreenVer(b.xp[3]-0.77*b.L*Math.sin(b.pitchDem*Math.PI/180)))
                context.strokeStyle = '#009900';
                context.stroke();
                context.beginPath();
                context.moveTo(ScreenHor(b.x),ScreenVer(b.xp[3]))
                context.lineTo(ScreenHor(b.x+0.7*b.L*Math.cos(b.xp[4])),ScreenVer(b.xp[3]-0.7*b.L*Math.sin(b.xp[4])))
                context.strokeStyle = '#00508a';
                context.stroke();
                
                //Depth
                context.font = "16px Courier New";
                context.fillStyle = "#00508a";
                context.textAlign = "left";
                  context.fillText("Depth: ".concat((b.xp[3]/b.SF).toFixed(2).toString(),'m'), ScreenHor(-1.5),ScreenVer(-0.7));
              
                //Depth Order
                context.font = "16px Courier New";
                context.fillStyle = "#00508a";
                context.textAlign = "left";
                  context.fillText("Order: ".concat((b.depthDem).toFixed(2).toString(),'m'), ScreenHor(-1.5),ScreenVer(-0.5));
              
                //CompTrim
                context.font = "16px Courier New";
                context.fillStyle = "#00508a";
                context.textAlign = "left";
                  context.fillText("TrimError: ".concat((b.trimErr).toFixed(2).toString()), ScreenHor(-1.5),ScreenVer(-0.3));
                  context.fillText("Trim Target: ".concat((b.TrimTarget)), ScreenHor(-1.5),ScreenVer(-0.1));
                  context.fillText("Trimz: ".concat(b.trimz.toFixed(2).toString()), ScreenHor(-0.25),ScreenVer(-0.5));
                
                //Pitch
                context.font = "16px Courier New";
                context.fillStyle = "#00508a";
                context.textAlign = "left";
                  context.fillText("Pitch: ".concat((b.xp[4]*180/Math.PI).toFixed(2).toString(),'°'), ScreenHor(0.25),ScreenVer(-0.7));
              
                //SeaState
                context.font = "16px Courier New";
                context.fillStyle = "#00508a";
                context.textAlign = "left";
                if (b.SeaFixed == 1){
                  context.fillText("Sea State: ".concat(b.SeaState.toFixed(0).toString()," (fixed)"), ScreenHor(-4.5),ScreenVer(-0.5));
                }else{
                  context.fillText("Sea State: ".concat(b.SeaState.toFixed(0).toString()), ScreenHor(-4.5),ScreenVer(-0.5));
                }
              
                
                //Waves
                b.waveshimmer = -1;//90*1/57;//+= SimSpeedSlider.value*0.5*Math.PI/180;
                /*
                if (b.waveshimmer>1*Math.PI){
                  b.waveshimmer = b.waveshimmer-1*Math.PI;
                }
                //*/
                
                context.lineWidth = 1;
                
                /*
                context.lineWidth = 1;
                context.beginPath();
                context.moveTo(ScreenHor(-4),ScreenVer(0));
                for (let i=0; i < (b.ssMY).length; i++) {
                  context.lineTo(ScreenHor(-4+8.1*i/b.ssMY.length),ScreenVer(0+Math.sin(b.waveshimmer*(8.22))*b.ssMY[i]/((2/b.SF)*(b.L/b.SF)*b.SeaForcePerScreenUnit)));
                }
                context.strokeStyle = '#129aca';
                //context.stroke();
                //*/
                
                // wave shading
                var wavechar;
              
                context.beginPath();
              context.moveTo(ScreenHor(-4.5),ScreenVer(0));
                for (let i=0; i < (b.ssFZ).length; i++) {
                  wavechar = Math.sin(b.waveshimmer*(5))*b.ssMoving[i]/((2/b.SF)*b.SeaForcePerScreenUnit);
                  context.lineTo(ScreenHor(-4.5+9.1*i/b.ssFZ.length),ScreenVer(0+wavechar));
                }
                for (let i=(b.ssFZ).length-1; i >= 0; i=i-1) {
                  wavechar = Math.sin(b.waveshimmer*(5))*b.ssMoving[i]/((2/b.SF)*b.SeaForcePerScreenUnit);
                  context.lineTo(ScreenHor(-4.5+9.1*i/b.ssFZ.length),ScreenVer(Math.max(wavechar,Math.max(wavechar+1*b.SF,1*b.SF))));
                }
  context.fillStyle = 'rgba(0,150,130,0.2)';
  context.fill();
              
              //blurred deep wave shadows:
               if (NiceGraphicsON.checked == true){
                 bgcontext.moveTo(ScreenHor(-4.5),ScreenVer(0));
                for (let i=0; i < (b.ssFZ).length; i++) {
                  wavechar = Math.sin(b.waveshimmer*(5))*b.ssMoving[i]/((2/b.SF)*b.SeaForcePerScreenUnit);
                  bgcontext.lineTo(ScreenHor(-4.5+9.1*i/b.ssFZ.length),ScreenVer(0+wavechar));
                }
                for (let i=(b.ssFZ).length-1; i >= 0; i=i-1) {
                  wavechar = Math.sin(b.waveshimmer*(5))*b.ssMoving[i]/((2/b.SF)*b.SeaForcePerScreenUnit);
                  bgcontext.lineTo(ScreenHor(-4.5+9.1*i/b.ssFZ.length-(0.5*1e3*(Math.pow(wavechar,2)))-0),ScreenVer(Math.max((2e3*(Math.pow(wavechar,2)))+0-wavechar,-wavechar)));
                }
              const shadowgrd = bgcontext.createLinearGradient(ScreenHor(-4.5), ScreenVer(-0), ScreenHor(-4.5), ScreenVer(2.0));
shadowgrd.addColorStop((15*b.SF)/2.0,'rgba(0,150,130,0.25)');
shadowgrd.addColorStop((45*b.SF)/2.0, 'rgba(0,160,180,0.2)');
shadowgrd.addColorStop(1.0, 'rgba(0,200,220,0.1)');
  bgcontext.fillStyle = shadowgrd;
  bgcontext.fill();
               };
                
                //fin
                let FinX = [-0.5,-0.54,-0.55,-0.6,-0.595,-0.6,
                                -0.6,-0.595,-0.6,-0.55,-0.54,-0.5];
                let FinY = [0,-1.1,-1.25,-1.25,-0.5,0,
                                 0,0.5, 1.15, 1.15, 1.05,0];
                context.beginPath();
                context.moveTo( ScreenHor(b.x
                                          +FinX[0]*b.L*Math.cos(b.xp[4])
                                          +FinY[0]*b.finH*Math.sin(b.xp[4])), 
                  ScreenVer(b.xp[3]
                            +FinY[0]*b.finH*Math.cos(b.xp[4])
                            -FinX[0]*b.L*Math.sin(b.xp[4])));
                for (var uf=0;uf<FinX.length;uf++){
                context.lineTo( ScreenHor(b.x
                                          +FinX[uf]*b.L*Math.cos(b.xp[4])
                                          +FinY[uf]*b.finH*Math.sin(b.xp[4])), 
                  ScreenVer(b.xp[3]
                            +FinY[uf]*b.finH*Math.cos(b.xp[4])
                            -FinX[uf]*b.L*Math.sin(b.xp[4])));
                };
                context.closePath();
                context.fillStyle = '#ffffff';
                context.fill();
                context.strokeStyle = '#00508a';
                context.stroke();
              
              
                // periscope array
                b.perH = 5*b.SF*Math.min(1,1/Math.max(1e-15,b.xp[3]/b.SF-(b.h*2+b.dsl)/b.SF));
                let PerX = [
                  0.44,
                  0.44,
                  0.452,
                  0.45,
                  0.445,
                  0.445,
                  //
                  0.422,
                  0.42,
                  0.42,
                  0.425,
                  0.42,
                  0.42,
                  0.415,
                  0.415,
                  0.415,
                  0.41,
                  0.415,
                  0.412,
                  //
                  0.395,
                  0.395,
                  0.39,
                  0.39,
                  //
                  0.375,
                  0.375,
                  0.372,
                  0.37,
                  0.37,
                ];
                let PerY = [
                  0,
                  -1.0,
                  -1.0,
                  -0.85,
                  -0.85,
                  0,
                  //
                  0,
                  -0.6,
                  -0.6,
                  -0.95,
                  -0.95,
                  -1.3,
                  -1.3,
                  -0.95,
                  -0.95,
                  -0.6,
                  -0.6,
                  0,
                  //
                  0,
                  -0.7,
                  -0.7,
                  0,
                  //
                  0,
                  -0.7,
                  -0.65,
                  -0.7,
                  0,
                ];
                context.beginPath();
                context.moveTo( ScreenHor(b.x
                                          +PerX[0]*b.L*Math.cos(b.xp[4])
                                          +(-b.h-b.dsl+PerY[0]*b.perH)*Math.sin(b.xp[4])), 
                  ScreenVer(b.xp[3]
                            +(-b.h-b.dsl+PerY[0]*b.perH)*Math.cos(b.xp[4])
                            -PerX[0]*b.L*Math.sin(b.xp[4])));
                for (var up=0;up<PerX.length;up++){
                context.lineTo( ScreenHor(b.x
                                          +PerX[up]*b.L*Math.cos(b.xp[4])
                                          +(-b.h-b.dsl+PerY[up]*b.perH)*Math.sin(b.xp[4])), 
                  ScreenVer(b.xp[3]
                            +(-b.h-b.dsl+PerY[up]*b.perH)*Math.cos(b.xp[4])
                            -PerX[up]*b.L*Math.sin(b.xp[4])));
                };
                context.closePath();
                context.fillStyle = '#666666';
                context.fill();
                
                //hull
                let HullX = [0.5, -0.3, -0.5, -0.62, -0.62, -0.5, -0.32, -0.12, -0.03, 0.28, 0.3, 0.34,0.36,0.44,0.46,0.48,0.5];
                let HullY = [b.h, b.h, 0.6*b.h, 0.2*b.h, 0,-0.4*b.h, -0.8*b.h, -0.8*b.h, -b.h,-b.h,-(b.h+0.2*b.dsl),-(b.h+0.9*b.dsl),-(b.h+b.dsl),-(b.h+b.dsl),-(b.h+0.9*b.dsl),-(b.h+0.2*b.dsl),-b.h];
                
                context.beginPath();
                context.moveTo( ScreenHor(b.x
                                          +HullX[0]*b.L*Math.cos(b.xp[4])
                                          +HullY[0]*Math.sin(b.xp[4])), 
                  ScreenVer(b.xp[3]
                            +HullY[0]*Math.cos(b.xp[4])
                            -HullX[0]*b.L*Math.sin(b.xp[4])));
                for (var uh=0;uh<HullX.length;uh++){
                  context.lineTo( ScreenHor(b.x
                                            +HullX[uh]*b.L*Math.cos(b.xp[4])
                                            +HullY[uh]*Math.sin(b.xp[4])), 
                    ScreenVer(b.xp[3]
                              +HullY[uh]*Math.cos(b.xp[4])
                              -HullX[uh]*b.L*Math.sin(b.xp[4])));
                };
                context.ellipse(ScreenHor(b.x+0.5*b.L*Math.cos(b.xp[4])), ScreenVer(b.xp[3]-0.5*b.L*Math.sin(b.xp[4])),ScreenHor(Math.max(0.15*b.L,b.h*1.25))-iOrigin, ScreenVer(b.h)-jOrigin, -b.xp[4], -Math.PI/2, Math.PI/2, false);
                context.fillStyle = 'rgba(255,255,255,1)';
                context.fill();
                //fill hull according to trim
                //proportionalized & capped trim error
                var maxte = 125;
                var pte = Math.min(maxte,Math.abs(b.trimOffset))/maxte;
                if (b.trimOffset > 0){
                  context.fillStyle = 'rgba(100,0,80,'+(pte)+')';
                  
                }else{
                  context.fillStyle = 'rgba(255,200,0,'+(pte)+')';
                  
                }
                context.fill();
                context.closePath();
                context.strokeStyle = '#00508a';
                context.stroke();
              
              
              
                /*
                context.beginPath();
                context.moveTo(ScreenHor(b.x-0.5*b.L*Math.cos(b.xp[4])), ScreenVer(b.xp[3]+0.5*b.L*Math.sin(b.xp[4])));
                context.lineTo(ScreenHor(b.x), ScreenVer(b.xp[3]));
                context.lineTo(ScreenHor(b.x+0.5*b.L*Math.cos(b.xp[4])), ScreenVer(b.xp[3]-0.5*b.L*Math.sin(b.xp[4])));
                //context.fill();
                context.strokeStyle = '#000000';
                context.stroke();//*/
              
              // trim compensation tank
              let tankH = 0.7; 
              context.beginPath();
                context.moveTo(
                  ScreenHor(+b.x
+((0.0)*b.L*Math.cos(b.xp[4])-tankH*b.h*Math.sin(b.xp[4]))),
                  ScreenVer(+b.xp[3]
+((0.0)*b.L*Math.sin(b.xp[4]))-tankH*b.h*Math.cos(b.xp[4])));
              
                context.lineTo(
                  ScreenHor(+b.x
+((0.5-20/100)*b.L*Math.cos(b.xp[4])-tankH*b.h*Math.sin(b.xp[4]))),
                  ScreenVer(+b.xp[3]
+(-(0.5-20/100)*b.L*Math.sin(b.xp[4]))-tankH*b.h*Math.cos(b.xp[4])));
              
                context.lineTo(
                  ScreenHor(+b.x
+((0.5-20/100)*b.L*Math.cos(b.xp[4])+tankH*b.h*Math.sin(b.xp[4]))),
                  ScreenVer(+b.xp[3]
+(-(0.5-20/100)*b.L*Math.sin(b.xp[4]))+tankH*b.h*Math.cos(b.xp[4])));
              
                context.lineTo(
                  ScreenHor(+b.x
+((0.0)*b.L*Math.cos(b.xp[4])+tankH*b.h*Math.sin(b.xp[4]))),
                  ScreenVer(+b.xp[3]
+(-(0.0)*b.L*Math.sin(b.xp[4]))+tankH*b.h*Math.cos(b.xp[4])));
              
                context.closePath();
                context.fillStyle = '#ffffff';
                context.fill();
                context.strokeStyle = '#00508a';
                context.stroke();
                //*/
              
                //Fill Tank:
              let filledTankH =  -tankH+2*tankH*0.9*(1-b.trimz/b.maxTrimz); 
              context.beginPath();
                context.moveTo(
                  ScreenHor(+b.x
+((0.0)*b.L*Math.cos(b.xp[4])-filledTankH*b.h*Math.sin(b.xp[4]))),
                  ScreenVer(+b.xp[3]
+((0.0)*b.L*Math.sin(b.xp[4]))-filledTankH*b.h*Math.cos(b.xp[4])));
              
                context.lineTo(
                  ScreenHor(+b.x
+((0.5-20/100)*b.L*Math.cos(b.xp[4])-filledTankH*b.h*Math.sin(b.xp[4]))),
                  ScreenVer(+b.xp[3]
+(-(0.5-20/100)*b.L*Math.sin(b.xp[4]))-filledTankH*b.h*Math.cos(b.xp[4])));
              
                context.lineTo(
                  ScreenHor(+b.x
+((0.5-20/100)*b.L*Math.cos(b.xp[4])+tankH*b.h*Math.sin(b.xp[4]))),
                  ScreenVer(+b.xp[3]
+(-(0.5-20/100)*b.L*Math.sin(b.xp[4]))+tankH*b.h*Math.cos(b.xp[4])));
              
                context.lineTo(
                  ScreenHor(+b.x
+((0.0)*b.L*Math.cos(b.xp[4])+tankH*b.h*Math.sin(b.xp[4]))),
                  ScreenVer(+b.xp[3]
+(-(0.0)*b.L*Math.sin(b.xp[4]))+tankH*b.h*Math.cos(b.xp[4])));
              
                context.closePath();
                context.fillStyle = '#019aca';
                context.fill();
                //context.strokeStyle = '#00508a';
                //context.stroke();
                
                //hydroplanes
                //ds
                ///*
                context.beginPath();
                context.moveTo(ScreenHor(0.1*b.h*Math.sin(b.xp[4])+b.dsl*Math.cos(-b.ui[2]*Math.PI/180-b.xp[4])+b.x-0.5*b.L*Math.cos(b.xp[4])), ScreenVer(0.1*b.h*Math.cos(b.xp[4])+b.dsl*Math.sin(-b.ui[2]*Math.PI/180-b.xp[4])+b.xp[3]+0.5*b.L*Math.sin(b.xp[4])));
                context.lineTo(ScreenHor(0.1*b.h*Math.sin(b.xp[4])+b.x-0.5*b.L*Math.cos(b.xp[4])), ScreenVer(0.1*b.h*Math.cos(b.xp[4])+b.xp[3]+0.5*b.L*Math.sin(b.xp[4])));
                context.lineTo(ScreenHor(0.1*b.h*Math.sin(b.xp[4])+-b.dsl*Math.cos(-b.ui[2]*Math.PI/180-b.xp[4])+b.x-0.5*b.L*Math.cos(b.xp[4])), ScreenVer(0.1*b.h*Math.cos(b.xp[4])-b.dsl*Math.sin(-b.ui[2]*Math.PI/180-b.xp[4])+b.xp[3]+0.5*b.L*Math.sin(b.xp[4])));
                context.strokeStyle = '#ff0000';
                context.stroke();
                //*/
                let pTh = b.dsl/5;
                context.beginPath();
                context.lineTo(ScreenHor(0.1*b.h*Math.sin(b.xp[4])+0*b.dsl*Math.cos(-b.ui[2]*Math.PI/180-b.xp[4])+b.x-0.5*b.L*Math.cos(b.xp[4])), ScreenVer(0.1*b.h*Math.cos(b.xp[4])+0*b.dsl*Math.sin(-b.ui[2]*Math.PI/180-b.xp[4])+b.xp[3]+0.5*b.L*Math.sin(b.xp[4])));
                context.lineTo(ScreenHor(0.1*b.h*Math.sin(b.xp[4])+0*b.dsl*Math.cos(-b.ui[2]*Math.PI/180-b.xp[4])+pTh*Math.sin(-b.ui[2]*Math.PI/180-b.xp[4])+b.x-0.5*b.L*Math.cos(b.xp[4])), ScreenVer(0.1*b.h*Math.cos(b.xp[4])+0*b.dsl*Math.sin(-b.ui[2]*Math.PI/180-b.xp[4])-pTh*Math.cos(-b.ui[2]*Math.PI/180-b.xp[4])+b.xp[3]+0.5*b.L*Math.sin(b.xp[4])));
                context.lineTo(ScreenHor(0.1*b.h*Math.sin(b.xp[4])+-1.5*b.dsl*Math.cos(-b.ui[2]*Math.PI/180-b.xp[4])+b.x-0.5*b.L*Math.cos(b.xp[4])), ScreenVer(0.1*b.h*Math.cos(b.xp[4])-1.5*b.dsl*Math.sin(-b.ui[2]*Math.PI/180-b.xp[4])+b.xp[3]+0.5*b.L*Math.sin(b.xp[4])));
                context.lineTo(ScreenHor(0.1*b.h*Math.sin(b.xp[4])+0*b.dsl*Math.cos(-b.ui[2]*Math.PI/180-b.xp[4])-pTh*Math.sin(-b.ui[2]*Math.PI/180-b.xp[4])+b.x-0.5*b.L*Math.cos(b.xp[4])), ScreenVer(0.1*b.h*Math.cos(b.xp[4])+0*b.dsl*Math.sin(-b.ui[2]*Math.PI/180-b.xp[4])+pTh*Math.cos(-b.ui[2]*Math.PI/180-b.xp[4])+b.xp[3]+0.5*b.L*Math.sin(b.xp[4])));
                context.ellipse(ScreenHor(0.1*b.h*Math.sin(b.xp[4])+0*b.dsl*Math.cos(-b.ui[2]*Math.PI/180-b.xp[4])+b.x-0.5*b.L*Math.cos(b.xp[4])), ScreenVer(0.1*b.h*Math.cos(b.xp[4])+0*b.dsl*Math.sin(-b.ui[2]*Math.PI/180-b.xp[4])+b.xp[3]+0.5*b.L*Math.sin(b.xp[4])), 0*PixelsPerMeter*0.02+ScreenHor(b.dsl*1/5)-iOrigin, 0*PixelsPerMeter*0.019+ScreenVer(b.dsl*0.95/5)-jOrigin, -b.ui[2]*Math.PI/180-b.xp[4], Math.PI/2, -Math.PI/2, true);
                context.strokeStyle = '#ffffff'//'#00508a';
                context.stroke();
                context.fillStyle = '#00508a';
                context.fill();
              
                ///db
                ///*
                context.beginPath();
                context.moveTo(ScreenHor(-0.7*b.h*Math.sin(b.xp[4])+b.dsl*Math.cos(-b.ui[1]*Math.PI/180+b.xp[4])+b.x+0.5*b.L*Math.cos(b.xp[4])), ScreenVer(-0.7*b.h*Math.cos(b.xp[4])+b.dsl*Math.sin(-b.ui[1]*Math.PI/180-b.xp[4])+b.xp[3]-0.5*b.L*Math.sin(b.xp[4])));
                context.lineTo(ScreenHor(-0.7*b.h*Math.sin(b.xp[4])+b.x+0.5*b.L*Math.cos(b.xp[4])), ScreenVer(-0.7*b.h*Math.cos(b.xp[4])+b.xp[3]-0.5*b.L*Math.sin(b.xp[4])));
                context.lineTo(ScreenHor(-0.7*b.h*Math.sin(b.xp[4])+-b.dsl*Math.cos(-b.ui[1]*Math.PI/180+b.xp[4])+b.x+0.5*b.L*Math.cos(b.xp[4])), ScreenVer(-0.7*b.h*Math.cos(b.xp[4])+-b.dsl*Math.sin(-b.ui[1]*Math.PI/180-b.xp[4])+b.xp[3]-0.5*b.L*Math.sin(b.xp[4])));
                //context.fill();
                context.strokeStyle = '#ff0000';
                context.stroke();
                context.strokeStyle = '#000000';
                //*/
                pTh = b.dsl/5;
                context.beginPath();
                context.lineTo(ScreenHor(-0.7*b.h*Math.sin(b.xp[4])+0*b.dsl*Math.cos(-b.ui[1]*Math.PI/180-b.xp[4])+b.x+0.5*b.L*Math.cos(b.xp[4])), ScreenVer(-0.7*b.h*Math.cos(b.xp[4])+0*b.dsl*Math.sin(-b.ui[1]*Math.PI/180-b.xp[4])+b.xp[3]-0.5*b.L*Math.sin(b.xp[4])));
                context.lineTo(ScreenHor(-0.7*b.h*Math.sin(b.xp[4])+0*b.dsl*Math.cos(-b.ui[1]*Math.PI/180-b.xp[4])+pTh*Math.sin(-b.ui[1]*Math.PI/180-b.xp[4])+b.x+0.5*b.L*Math.cos(b.xp[4])), ScreenVer(-0.7*b.h*Math.cos(b.xp[4])+0*b.dsl*Math.sin(-b.ui[1]*Math.PI/180-b.xp[4])-pTh*Math.cos(-b.ui[1]*Math.PI/180-b.xp[4])+b.xp[3]-0.5*b.L*Math.sin(b.xp[4])));
                context.lineTo(ScreenHor(-0.7*b.h*Math.sin(b.xp[4])+-1.5*b.dsl*Math.cos(-b.ui[1]*Math.PI/180-b.xp[4])+b.x+0.5*b.L*Math.cos(b.xp[4])), ScreenVer(-0.7*b.h*Math.cos(b.xp[4])-1.5*b.dsl*Math.sin(-b.ui[1]*Math.PI/180-b.xp[4])+b.xp[3]-0.5*b.L*Math.sin(b.xp[4])));
                context.lineTo(ScreenHor(-0.7*b.h*Math.sin(b.xp[4])+0*b.dsl*Math.cos(-b.ui[1]*Math.PI/180-b.xp[4])-pTh*Math.sin(-b.ui[1]*Math.PI/180-b.xp[4])+b.x+0.5*b.L*Math.cos(b.xp[4])), ScreenVer(-0.7*b.h*Math.cos(b.xp[4])+0*b.dsl*Math.sin(-b.ui[1]*Math.PI/180-b.xp[4])+pTh*Math.cos(-b.ui[1]*Math.PI/180-b.xp[4])+b.xp[3]-0.5*b.L*Math.sin(b.xp[4])));
                context.ellipse(ScreenHor(-0.7*b.h*Math.sin(b.xp[4])+0*b.dsl*Math.cos(-b.ui[1]*Math.PI/180-b.xp[4])+b.x+0.5*b.L*Math.cos(b.xp[4])), ScreenVer(-0.7*b.h*Math.cos(b.xp[4])+0*b.dsl*Math.sin(-b.ui[1]*Math.PI/180-b.xp[4])+b.xp[3]-0.5*b.L*Math.sin(b.xp[4])), 0*PixelsPerMeter*0.016+ScreenHor(b.dsl*1/5)-iOrigin, 0*PixelsPerMeter*0.016+ScreenVer(b.dsl*1/5)-jOrigin, -b.ui[1]*Math.PI/180-b.xp[4], Math.PI/2, -Math.PI/2, true);
                context.strokeStyle = '#ffffff'//'#00508a';
                context.stroke();
                context.fillStyle = '#00508a';
                context.fill();
              
              //
                context.strokeStyle = '#00508a'
                context.fillStyle = '#ffffff';
                context.lineWidth = 0.5;
                context.beginPath();
                context.arc(ScreenHor(-0.7*b.h*Math.sin(b.xp[4])+b.x+0.5*b.L*Math.cos(b.xp[4])), ScreenVer(-0.7*b.h*Math.cos(b.xp[4])+b.xp[3]-0.5*b.L*Math.sin(b.xp[4])), pixelRadius, 0, 2*Math.PI, true);
                context.fill();
                context.stroke();
                context.beginPath();
                context.arc(ScreenHor(0.1*b.h*Math.sin(b.xp[4])+b.x-0.5*b.L*Math.cos(b.xp[4])), ScreenVer(0.1*b.h*Math.cos(b.xp[4])+b.xp[3]+0.5*b.L*Math.sin(b.xp[4])), pixelRadius, 0, 2*Math.PI, true);
                context.fill();
                context.stroke();
              
              context.beginPath();
              context.moveTo(ScreenHor(-4.5),ScreenVer(0));
                for (let i=0; i < (b.ssFZ).length; i++) {
                  wavechar = Math.sin(b.waveshimmer*(5))*b.ssMoving2[i]/((2/b.SF)*b.SeaForcePerScreenUnit);
                  context.lineTo(ScreenHor(-4.5+9.1*i/b.ssFZ.length),ScreenVer(0+wavechar));
                }
                for (let i=(b.ssFZ).length-1; i >= 0; i=i-1) {
                  wavechar = Math.sin(b.waveshimmer*(5))*b.ssMoving2[i]/((2/b.SF)*b.SeaForcePerScreenUnit);
                  context.lineTo(ScreenHor(-4.5+9.1*i/b.ssFZ.length),ScreenVer(Math.max(wavechar,Math.max(wavechar+1*b.SF,1*b.SF))));
                }
  context.fillStyle = 'rgba(0,155,205,0.2)';//'rgba(0,150,130,0.2)';
  context.fill();
              
            } else {
            }
        }
    }
    function OnMouseDown(e) {
      //console.log(e.keyCode)
      //console.log("incDB")const 
      canvas = document.getElementById('SimCanvas');
      const hor = e.pageX - canvas.offsetLeft;
      const ver = e.pageY - canvas.offsetTop;
      const z = -WorldY(ver)/(1/50); // match this scaling to b.SF
      sim.depthOrder(z);
      RTPDbutton.value="false";
      RTPDbutton.style.backgroundColor="#f0f0f0";
      RTSDbutton.value="false";
      RTSDbutton.style.backgroundColor="#f0f0f0";
      
      RTDDbutton.value="false";
      RTDDbutton.style.backgroundColor="#f0f0f0";
    }
    function doKeyDown(e) {
      //console.log(e.keyCode)
      if (e.keyCode == 84){
        sim.APall();
      }
      if (e.keyCode == 65){
        sim.incDS();
      }
      if (e.keyCode == 90){
        sim.decDS();
      }
      if (e.keyCode == 75){
        sim.incDB();
      }
      if (e.keyCode == 77){
        sim.decDB();
      }
      if (e.keyCode == 73){
        sim.intReset();
      }
      if (e.keyCode == 80){
        sim.pitchSP_up();
      }
      if (e.keyCode == 76){
        sim.pitchSP_down();
      }
      if (e.keyCode == 79){
        sim.pitchSP_level();
      }
      if (e.keyCode == 67){
        sim.toggleCompressibility();
      }
      if (e.keyCode == 86){
        sim.toggleTrimCompensator();
      }
      if (e.keyCode == 66){
        sim.toggleTrimTarget();
      }
      if (e.keyCode == 82){
        sim.pitchSP_level();
        sim.intReset();
        sim.ResetStates();
      }
      if (e.keyCode == 83){
        sim.SeaToggle();
      }else if (e.keyCode >= 48 && e.keyCode <= 57){
        sim.SeaSelect(e.keyCode);
      }
    }
    var time = 0;
    function AnimationFrame() {
        // Physics constants
    let SimStepsPerFrame = 1;
    if (SimSpeedSlider.value == 0){
      SimStepsPerFrame = 0;
    }else{
      SimStepsPerFrame = SimSpeedSlider.value;
    }; //1000 -- synonymous with simulation speed
    const FrameDelayMillis = SimStepsPerFrame*10;//10; //10
        const dt = 0.05;//(0.00125 * FrameDelayMillis) / SimStepsPerFrame; //0.0025
        for (let i=0; i < SimStepsPerFrame; ++i) {
            sim.Update(dt);
            time = time+dt;
        }
        Render(sim);
        
        //Timerbutton.innerHTML = dt;
        if (Math.round(time*10)%5 == 0){
          Timerbutton.innerHTML = time.toFixed(2);
        }
        //*/
        window.setTimeout(AnimationFrame, 25); //FrameDelayMillis
    }
    var lastDownTarget, canvas;
    window.onload = function() {
        sim = InitWorld();
        const canvas = document.getElementById('SimCanvas');
        canvas.addEventListener( "keydown", doKeyDown,true);
        canvas.addEventListener('mousedown', OnMouseDown);
        AnimationFrame();
    }
})();
function isNumberKey(evt) {
  var charCode = (evt.which) ? evt.which : evt.keyCode
  if (charCode > 31 && (charCode != 46 && charCode != 45 &&(charCode < 48 || charCode > 57)))
    return false;
  return true;
}
function TogglePlaneGainsTable(){
  if(AftPlaneGainsTable.style.display=='none'){AftPlaneGainsTable.style.display='';FwdPlaneGainsTable.style.display='';PlaneGainsToggle.innerHTML="Close Diveplane Controller";CtrlSettingsTable.style.display='';
                                              }else{AftPlaneGainsTable.style.display='none';FwdPlaneGainsTable.style.display='none';PlaneGainsToggle.innerHTML="Edit Diveplane Controller";CtrlSettingsTable.style.display='none';};
  
  console.log('togglePlaneCtrl');
}
function TogglePlantPhysicsTable(){
  if(PlantPhysicsTable.style.display=='none'){
    PlantPhysicsTable.style.display='';PlantPhysicsToggle.innerHTML="Close Submarine Plant";UpdatePlantbutton.style.display='';
                                             }else{
                                               PlantPhysicsTable.style.display='none';PlantPhysicsToggle.innerHTML="Edit Submarine Plant";UpdatePlantbutton.style.display='none';
                                             };
  
  console.log('togglePlantPhysics');
}
function ToggleFreezeDepth(){
  if (FreezeDepthToggle.innerHTML == 'Unfreeze Depth'){
    FreezeDepthToggle.innerHTML = 'Freeze Depth';
  }else{
    FreezeDepthToggle.innerHTML = 'Unfreeze Depth';
  }
}
    function RTPD(){
      if (RTPDbutton.value=="false"){
        RTPDbutton.value="true";
        RTPDbutton.style.backgroundColor= '#ffca01';
        RTSDbutton.value="false";
        RTSDbutton.style.backgroundColor= '#f0f0f0';
        RTDDbutton.value="false";
        RTDDbutton.style.backgroundColor= '#f0f0f0';
      }else{
        //RTPDbutton.value="false";
        //RTPDbutton.style.backgroundColor= '#f0f0f0';
      }
      //console.log(RTPDbutton.value);
    }
      function RTSD(){
      if (RTSDbutton.value=="false"){
        RTSDbutton.value="true";
        RTSDbutton.style.backgroundColor= '#ffca01';
        RTPDbutton.value="false";
        RTPDbutton.style.backgroundColor= '#f0f0f0';
        RTDDbutton.value="false";
        RTDDbutton.style.backgroundColor= '#f0f0f0';
      }else{
        //RTSDbutton.value="false";
        //RTSDbutton.style.backgroundColor= '#f0f0f0';
      }
      //console.log(RTSDbutton.value);
    }
      function RTDD(){
      if (RTDDbutton.value=="false"){
        RTDDbutton.value="true";
        RTDDbutton.style.backgroundColor= '#ffca01';
        RTPDbutton.value="false";
        RTPDbutton.style.backgroundColor= '#f0f0f0';
        RTSDbutton.value="false";
        RTSDbutton.style.backgroundColor= '#f0f0f0';
      }else{
        //RTSDbutton.value="false";
        //RTSDbutton.style.backgroundColor= '#f0f0f0';
      }
      //console.log(RTSDbutton.value);
    }

</script> 
</body>
</html>
